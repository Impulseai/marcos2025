<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #E63946; /* Vermelho vibrante */
            --secondary-color: #D62828; /* Vermelho mais escuro */
            --accent-color: #F77F00; /* Laranja forte */
            --accent-secondary: #FCBF49; /* Amarelo dourado */
            --background-light: #FFF8F0; /* Bege claro */
            --text-light: #333;
            --background-dark: #2D2A32; /* Escuro quente */
            --text-dark: #FFF8F0;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --card-border-radius: 12px;
            --button-border-radius: 8px;
            --transition-default: all 0.3s ease;
            --whatsapp-light: #e5ddd5; /* Cor do fundo WhatsApp claro */
            --whatsapp-dark: #0b141a; /* Cor do fundo WhatsApp escuro */
        }

        .dark {
            --primary-color: #E63946;
            --secondary-color: #D62828;
            --accent-color: #F77F00;
            --accent-secondary: #FCBF49;
            --background: #2D2A32;
            --text: #FFF8F0;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.25);
        }

        body {
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-light);
        }

        .dark body {
            background-color: var(--background-dark);
        }

        /* Estilo para o fundo do chat com a imagem de comida verde */
        .chat-container-bg {
            background-image: url("https://pfst.cf2.poecdn.net/base/image/e5c76bea7cf2c6d1d160fb9901a0f97164e53093689531569a54f0ea1919d22b?w=1024&h=1536");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .dark .chat-container-bg {
            background-image: url("https://pfst.cf2.poecdn.net/base/image/e5c76bea7cf2c6d1d160fb9901a0f97164e53093689531569a54f0ea1919d22b?w=1024&h=1536");
            background-size: cover;
            background-position: center;
            filter: brightness(0.85);
        }

        .chat-message {
            max-width: 80%;
            margin-bottom: 10px;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            transition: var(--transition-default);
        }

        .customer {
            background-color: #dcf8c6; /* Cor de mensagem do WhatsApp */
            color: #303030;
            margin-left: auto;
            border-radius: 12px 0 12px 12px;
        }

        .bot {
            background-color: white;
            color: #303030;
            margin-right: auto;
            border-radius: 0 12px 12px 12px;
        }

        .dark .bot {
            background-color: #222e35; /* Cor de mensagem do WhatsApp escuro */
            color: #e9edef;
        }

        .dark .customer {
            background-color: #005c4b; /* Cor de mensagem do usu√°rio no WhatsApp escuro */
            color: #e9edef;
        }

        .message-input {
            border: none;
            outline: none;
            padding: 12px 16px;
            border-radius: 20px;
            margin-right: 10px;
            flex: 1;
            transition: var(--transition-default);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message-input:focus {
            box-shadow: 0 2px 15px rgba(230, 57, 70, 0.2);
        }

        .option-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            margin: 6px;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            transition: var(--transition-default);
            box-shadow: var(--box-shadow);
        }

        .option-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .tab {
            cursor: pointer;
            padding: 10px 0;
            text-align: center;
            transition: all 0.3s;
        }

        .active-tab {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            transition: var(--transition-default);
        }

        .cart-item:hover {
            background-color: rgba(230, 57, 70, 0.05);
        }

        .dark .cart-item {
            border-bottom: 1px solid #4B5563;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .print-receipt {
            font-family: monospace;
            width: 300px;
            padding: 10px;
            background-color: white;
            color: black;
            line-height: 1.5;
        }

        /* Loading spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .menu-category {
            margin-bottom: 12px;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .menu-item:hover {
            background-color: rgba(230, 57, 70, 0.1);
            border-color: rgba(230, 57, 70, 0.2);
            transform: translateY(-2px);
        }

        .dark .menu-item:hover {
            background-color: rgba(230, 57, 70, 0.2);
        }

        .menu-item-price {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Tab Panel Style */
        .page {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Checkbox para acr√©scimos */
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .checkbox-item:hover {
            background-color: rgba(230, 57, 70, 0.1);
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }
        
        /* Modal de compartilhamento */
        .share-options a, .share-options button {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .share-options a:hover, .share-options button:hover {
            background-color: rgba(230, 57, 70, 0.1);
            transform: translateX(5px);
        }
        
        .share-options i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
            font-size: 1.2em;
        }
        
        /* Gr√°ficos para comiss√µes */
        .chart-container {
            height: 200px;
            position: relative;
            padding: 20px 0;
        }
        
        .bar {
            position: absolute;
            bottom: 0;
            width: 40px;
            background-color: var(--primary-color);
            transition: height 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            box-shadow: 0 -2px 10px rgba(230, 57, 70, 0.3);
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            text-align: center;
            font-size: 12px;
            width: 40px;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            width: 40px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Estilos do header */
        .main-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: var(--card-border-radius);
            overflow: hidden;
        }

        .dark .main-header {
            background-color: #2D2A32;
            box-shadow: 0 2px 10px rgba(0,0,0,0.25);
        }

        /* Estilos de navega√ß√£o do admin */
        .shop-nav {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 0 10px;
        }

        .shop-nav::-webkit-scrollbar {
            display: none;
        }
        
        .shop-nav-link {
            position: relative;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            padding: 10px 0;
            margin: 0 12px;
        }
        
        .shop-nav-link:hover {
            color: var(--primary-color);
        }
        
        .shop-nav-link.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* Card styles */
        .card {
            border-radius: var(--card-border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition-default);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        /* Button styles */
        .btn {
            transition: var(--transition-default);
            border-radius: var(--button-border-radius);
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-accent {
            background-color: var(--accent-color);
        }
        
        .btn-accent:hover {
            background-color: var(--accent-secondary);
        }
        
        /* Logo animation */
        .logo-container {
            transition: var(--transition-default);
        }
        
        .logo-container:hover img {
            transform: rotate(10deg) scale(1.1);
        }
        
        .logo-container img {
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        /* Form inputs */
        .form-input {
            transition: var(--transition-default);
            border-radius: 8px;
            border: 2px solid transparent;
            padding: 10px 12px;
            font-size: 16px;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(230, 57, 70, 0.15);
        }
        
        /* Password strength meter */
        .password-strength {
            height: 5px;
            border-radius: 3px;
            margin-top: 5px;
            transition: var(--transition-default);
        }
        
        .password-weak {
            background-color: #e74c3c;
            width: 30%;
        }
        
        .password-medium {
            background-color: #f39c12;
            width: 60%;
        }
        
        .password-strong {
            background-color: #2ecc71;
            width: 100%;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* Melhorias para dispositivos m√≥veis */
        @media (max-width: 640px) {
            .chat-message {
                max-width: 90%;
                padding: 10px 12px;
            }
            
            .option-button {
                padding: 8px 12px;
                margin: 4px;
                font-size: 14px;
                width: 100%;
            }
            
            #options-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .card {
                padding: 12px !important;
            }
            
            .admin-nav-link {
                margin: 0 8px;
                font-size: 14px;
            }
            
            .print-receipt {
                width: 100%;
                font-size: 12px;
            }
            
            .cart-sidebar {
                width: 100% !important;
            }
            
            .notification {
                width: 90%;
                left: 5%;
                right: 5%;
                text-align: center;
            }
        }

        /* Efeitos de comida */
        .food-icon {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .promotion-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            position: relative;
            overflow: hidden;
        }

        .promotion-badge::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            100% { left: 100%; }
        }
        
        /* Estilo para o avatar do cliente */
        .client-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin: 0 auto 15px auto;
            transition: all 0.3s ease;
        }
        
        .client-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        /* Estilo para mensagem de hor√°rio no chat (como no WhatsApp) */
        .message-time {
            font-size: 11px;
            color: #8696a0;
            margin-top: 4px;
            text-align: right;
        }

        .dark .message-time {
            color: #8696a0;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
    <div class="container mx-auto px-4 py-4 max-w-screen-md">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg mb-4 main-header">
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center logo-container" id="logo-container">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBkPSJNMjU2IDhDMTE5LjA0MyA4IDggMTE5LjA4IDggMjU2YzAgMTM2Ljk5NyAxMTEuMDQzIDI0OCAyNDggMjQ4czI0OC0xMTEuMDAzIDI0OC0yNDhDNTA0IDExOS4wOCAzOTIuOTU3IDggMjU2IDh6bTAgMTEwYzIzLjE5NiAwIDQyIDE4LjgwNCA0MiA0MnMtMTguODA0IDQyLTQyIDQyLTQyLTE4LjgwNC00Mi00MiAxOC44MDQtNDIgNDItNDJ6bTU2IDI1NGMwIDYuNjI3LTUuMzczIDEyLTEyIDEyaC04OGMtNi42MjcgMC0xMi01LjM3My0xMi0xMnYtMjRjMC02LjYyNyA1LjM3My0xMiAxMi0xMmgxMnYtNjRoLTEyYy02LjYyNyAwLTEyLTUuMzczLTEyLTEydi0yNGMwLTYuNjI3IDUuMzczLTEyIDEyLTEyaDY0YzYuNjI3IDAgMTIgNS4zNzMgMTIgMTJ2MTAwaDEyYzYuNjI3IDAgMTIgNS4zNzMgMTIgMTJ2MjR6IiBmaWxsPSIjRTYzOTQ2Ii8+PC9zdmc+" alt="Marcos" class="h-10 w-10 mr-2">
                    <h2 class="text-xl font-bold bg-gradient-to-r from-red-500 to-yellow-500 bg-clip-text text-transparent">Marcos</h2>
                </div>
                <div class="flex items-center">
                    <!-- Bot√£o do carrinho (s√≥ aparece nas p√°ginas de cliente) -->
                    <div id="cart-button-container" class="hidden">
                        <button id="toggle-cart" class="text-gray-700 dark:text-gray-300 hover:text-red-600 dark:hover:text-red-400 transition-all duration-300">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-count" class="bg-yellow-500 text-white rounded-full px-2 py-1 text-xs animate-pulse">0</span>
                        </button>
                    </div>
                    <!-- Bot√µes de navega√ß√£o principal -->
                    <div id="nav-buttons" class="ml-4 flex space-x-2">
                        <button id="btn-client" class="nav-btn px-3 py-1 rounded text-sm bg-red-500 hover:bg-red-600 text-white transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-home mr-1"></i> Cliente
                        </button>
                        <button id="btn-admin" class="nav-btn px-3 py-1 rounded text-sm bg-gray-300 hover:bg-gray-400 text-gray-700 transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-store mr-1"></i> Loja
                        </button>
                        <button id="btn-register" class="nav-btn px-3 py-1 rounded text-sm bg-yellow-500 hover:bg-yellow-600 text-white transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-user-plus mr-1"></i> Cadastrar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Admin navbar (aparece apenas nas p√°ginas de admin) -->
            <div id="admin-navbar" class="shop-nav px-4 pb-2 border-t border-gray-200 dark:border-gray-700 hidden">
                <div class="flex space-x-4">
                    <a href="#" id="nav-dashboard" class="shop-nav-link text-gray-600 dark:text-gray-300 py-2 border-b-2 border-transparent">
                        <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
                    </a>
                    <a href="#" id="nav-orders" class="shop-nav-link text-gray-600 dark:text-gray-300 py-2 border-b-2 border-transparent">
                        <i class="fas fa-shopping-bag mr-1"></i> Pedidos
                    </a>
                    <a href="#" id="nav-customers" class="shop-nav-link text-gray-600 dark:text-gray-300 py-2 border-b-2 border-transparent">
                        <i class="fas fa-users mr-1"></i> Clientes
                    </a>
                    <a href="#" id="nav-menu" class="shop-nav-link text-gray-600 dark:text-gray-300 py-2 border-b-2 border-transparent">
                        <i class="fas fa-utensils mr-1"></i> Card√°pio
                    </a>
                    <a href="#" id="nav-impulse" class="shop-nav-link text-gray-600 dark:text-gray-300 py-2 border-b-2 border-transparent">
                        <i class="fas fa-chart-line mr-1"></i> ImpulseAI
                    </a>
                    <a href="#" id="nav-settings" class="shop-nav-link text-gray-600 dark:text-gray-300 py-2 border-b-2 border-transparent">
                        <i class="fas fa-cog mr-1"></i> Configura√ß√µes
                    </a>
                </div>
            </div>
        </div>

        <!-- Container principal para p√°ginas -->
        <div id="page-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden card">
            <!-- P√ÅGINA: Cliente In√≠cio -->
            <div id="page-client" class="page">
                <div id="client-signin" class="p-4 animate-fade-in">
                    <h3 class="text-lg font-bold mb-4 text-center text-red-600 dark:text-red-400">Seja bem-vindo ao Marcos! <i class="fas fa-robot ml-1"></i></h3>
                    
                    <!-- Avatar do usu√°rio -->
                    <div class="flex justify-center mb-4">
                        <img src="https://pfst.cf2.poecdn.net/base/image/a42b2c0a7147ba259373c1a7f9ecd666a88580d617d5db629ec130e765d2df93?w=1024&h=1024" alt="Avatar" class="client-avatar">
                    </div>
                    
                    <p class="mb-4 text-center">Para fazer seu pedido, complete seu cadastro ou fa√ßa login:</p>
                    
                    <div class="bg-white dark:bg-gray-700 rounded-lg p-6 shadow-md mb-6 transform transition duration-500 hover:shadow-xl">
                        <div class="mb-4">
                            <label for="customer-name" class="block mb-2 font-medium">Nome completo</label>
                            <input type="text" id="customer-name" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-600 dark:text-white dark:border-gray-500 form-input" placeholder="Seu nome">
                        </div>
                        <div class="mb-4">
                            <label for="customer-phone" class="block mb-2 font-medium">WhatsApp</label>
                            <input type="tel" id="customer-phone" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-600 dark:text-white dark:border-gray-500 form-input" placeholder="(00) 00000-0000">
                        </div>
                        <div class="mb-4">
                            <label for="customer-address" class="block mb-2 font-medium">Endere√ßo completo (para entrega)</label>
                            <input type="text" id="customer-address" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-600 dark:text-white dark:border-gray-500 form-input" placeholder="Rua, n√∫mero, bairro, cidade">
                        </div>
                        <button id="customer-login" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded transition duration-300 transform hover:scale-105 btn">
                            Continuar
                        </button>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">J√° fez pedidos antes?</p>
                        <button id="find-by-phone" class="text-red-500 hover:text-red-700 font-medium transition duration-300 transform hover:scale-105">
                            <i class="fas fa-search mr-1"></i> Buscar por WhatsApp
                        </button>
                    </div>
                </div>

                <div id="client-chat" class="p-4 hidden">
                    <!-- Chat Container -->
                    <div id="chat-container" class="h-96 overflow-y-auto chat-container-bg p-4 rounded-lg mb-4 shadow-inner">
                        <!-- Chat messages will be inserted here -->
                    </div>

                    <!-- Options Container -->
                    <div id="options-container" class="mb-4 flex flex-wrap justify-center">
                        <!-- Option buttons will be inserted here -->
                    </div>

                    <!-- Input Container -->
                    <div class="flex items-center bg-white dark:bg-gray-800 rounded-full shadow-md p-2">
                        <input type="text" id="message-input" class="message-input bg-transparent dark:text-white text-base" placeholder="Digite sua mensagem...">
                        <button id="send-button" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center transition-all duration-300 transform hover:rotate-12">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja Login -->
            <div id="page-admin-login" class="page">
                <div class="p-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 shadow-md max-w-md mx-auto transform transition duration-500 hover:shadow-xl">
                        <div class="text-center mb-6">
                            <i class="fas fa-store text-red-500 text-4xl mb-3"></i>
                            <h2 class="text-2xl font-bold">√Årea da Loja</h2>
                            <p class="text-gray-500 dark:text-gray-400 mt-1">Acesse sua √°rea administrativa</p>
                        </div>
                        <div class="mb-4">
                            <label for="admin-email" class="block mb-2 font-medium">E-mail</label>
                            <div class="relative">
                                <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="email" id="admin-email" class="w-full p-3 pl-10 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="email@exemplo.com">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="admin-password" class="block mb-2 font-medium">Senha</label>
                            <div class="relative">
                                <i class="fas fa-key absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="password" id="admin-password" class="w-full p-3 pl-10 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Sua senha">
                            </div>
                        </div>
                        <button id="admin-login-button" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded transition duration-300 transform hover:scale-105 flex items-center justify-center btn">
                            <i class="fas fa-sign-in-alt mr-2"></i> Entrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja Cadastro -->
            <div id="page-admin-register" class="page">
                <div class="p-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 shadow-md max-w-md mx-auto transform transition duration-500 hover:shadow-xl">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-red-600 dark:text-red-400">Cadastro</h2>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Crie sua conta de loja</p>
                            </div>
                            <button id="back-to-login" class="text-red-500 hover:text-red-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-arrow-left mr-1"></i> Voltar
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <label for="register-name" class="block mb-2 font-medium">Nome da Empresa</label>
                            <input type="text" id="register-name" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Nome da sua empresa">
                        </div>
                        <div class="mb-4">
                            <label for="register-address" class="block mb-2 font-medium">Endere√ßo</label>
                            <input type="text" id="register-address" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Endere√ßo completo">
                        </div>
                        <div class="mb-4">
                            <label for="register-phone" class="block mb-2 font-medium">Telefone</label>
                            <input type="tel" id="register-phone" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="(00) 00000-0000">
                        </div>
                        <div class="mb-4">
                            <label for="register-email" class="block mb-2 font-medium">E-mail</label>
                            <input type="email" id="register-email" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="email@exemplo.com">
                        </div>
                        <div class="mb-4">
                            <label for="register-password" class="block mb-2 font-medium">Senha</label>
                            <input type="password" id="register-password" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Crie uma senha forte">
                            <div id="password-strength" class="password-strength"></div>
                        </div>
                        <div class="mb-6">
                            <label for="register-confirm" class="block mb-2 font-medium">Confirmar Senha</label>
                            <input type="password" id="register-confirm" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Confirme sua senha">
                        </div>
                        <button id="complete-register" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded transition duration-300 transform hover:scale-105 flex items-center justify-center btn">
                            <i class="fas fa-user-plus mr-2"></i> Concluir Cadastro
                        </button>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja Dashboard -->
            <div id="page-admin-dashboard" class="page">
                <div class="p-4">
                    <div class="mb-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-red-600 dark:text-red-400">Dashboard</h2>
                        <div class="flex space-x-2">
                            <button id="share-app" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded text-sm transition duration-300 transform hover:scale-105 btn">
                                <i class="fas fa-share-alt mr-1"></i> Compartilhar
                            </button>
                            <button id="admin-logout" class="text-red-500 hover:text-red-700 transition duration-300">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </button>
                        </div>
                    </div>

                    <!-- Restaurant Info -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-red-600 dark:text-red-400">Informa√ß√µes da Empresa</h3>
                            <button id="edit-info-button" class="text-red-500 hover:text-red-700 transition duration-300 transform hover:scale-110">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div id="restaurant-info" class="space-y-2">
                            <p><strong>Nome:</strong> <span id="info-name">Marcos</span></p>
                            <p><strong>Endere√ßo:</strong> <span id="info-address">Rua das Palmeiras, 123</span></p>
                            <p><strong>Telefone:</strong> <span id="info-phone">(11) 99999-9999</span></p>
                        </div>
                        <div id="edit-info-form" class="hidden space-y-3 mt-3">
                            <div class="mb-2">
                                <label class="block mb-1 font-medium">Nome</label>
                                <input type="text" id="edit-name" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                            </div>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium">Endere√ßo</label>
                                <input type="text" id="edit-address" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                            </div>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium">Telefone</label>
                                <input type="text" id="edit-phone" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="cancel-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition duration-300 btn">
                                    Cancelar
                                </button>
                                <button id="save-info" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded transition duration-300 btn">
                                    Salvar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Promotion Settings Card (NOVO) -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-red-600 dark:text-red-400">Promo√ß√£o do Dia</h3>
                            <button id="edit-promo-button" class="text-red-500 hover:text-red-700 transition duration-300 transform hover:scale-110">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div id="promotion-info" class="space-y-2">
                            <p><strong>Status:</strong> <span id="promo-status">Ativa</span></p>
                            <p><strong>T√≠tulo:</strong> <span id="promo-title">üçî Promo√ß√£o do Dia!</span></p>
                            <p><strong>Texto:</strong> <span id="promo-text">Pe√ßa agora e ganhe 10% OFF</span></p>
                        </div>
                        <div id="edit-promo-form" class="hidden space-y-3 mt-3">
                            <div class="mb-2">
                                <label class="block mb-1 font-medium">Status</label>
                                <select id="edit-promo-status" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                                    <option value="active">Ativa</option>
                                    <option value="inactive">Inativa</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium">T√≠tulo</label>
                                <input type="text" id="edit-promo-title" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                            </div>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium">Texto</label>
                                <input type="text" id="edit-promo-text" class="w-full p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="cancel-promo-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition duration-300 btn">
                                    Cancelar
                                </button>
                                <button id="save-promo" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded transition duration-300 btn">
                                    Salvar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <h3 class="font-bold mb-3 text-red-600 dark:text-red-400">Estat√≠sticas do Dia</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-red-100 dark:bg-red-900 rounded transform transition duration-300 hover:scale-105">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Pedidos</p>
                                <p id="stats-orders" class="text-2xl font-bold text-red-600 dark:text-red-400">0</p>
                            </div>
                            <div class="text-center p-4 bg-yellow-100 dark:bg-yellow-900 rounded transform transition duration-300 hover:scale-105">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Total (R$)</p>
                                <p id="stats-total" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">0,00</p>
                            </div>
                            <div class="text-center p-4 bg-orange-100 dark:bg-orange-900 rounded transform transition duration-300 hover:scale-105">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Pagamentos</p>
                                <div class="text-xs mt-2">
                                    <span id="stats-pix" class="block py-1">Pix: 0</span>
                                    <span id="stats-card" class="block py-1">Cart√£o: 0</span>
                                    <span id="stats-cash" class="block py-1">Dinheiro: 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-red-600 dark:text-red-400">Pedidos Recentes</h3>
                            <button id="view-all-orders" class="text-red-500 hover:text-red-700 text-sm transition duration-300 transform hover:scale-105">
                                Ver Todos <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        <div id="recent-orders" class="space-y-3">
                            <p id="no-recent-orders" class="text-center text-gray-500 py-4">Nenhum pedido recente.</p>
                            <!-- Recent orders will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja Pedidos -->
            <div id="page-admin-orders" class="page">
                <div class="p-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="font-bold text-xl text-red-600 dark:text-red-400 mb-2 sm:mb-0">Pedidos em Tempo Real</h3>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button id="export-orders-csv" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button id="export-orders-excel" class="bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md card">
                        <div class="mb-4">
                            <label class="block mb-2 font-medium">Filtrar por Data</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <input type="date" id="filter-date" class="p-2 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input w-full sm:w-auto">
                                <div class="flex space-x-2 w-full sm:w-auto">
                                    <button id="apply-filter" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn flex-1 sm:flex-none">
                                        <i class="fas fa-filter mr-1"></i> Filtrar
                                    </button>
                                    <button id="clear-filter" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition duration-300 btn flex-1 sm:flex-none">
                                        <i class="fas fa-times mr-1"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="orders-container" class="space-y-4">
                            <!-- Orders will be inserted here -->
                            <p id="no-orders-message" class="text-center text-gray-500 py-8">Nenhum pedido ainda.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja Clientes -->
            <div id="page-admin-customers" class="page">
                <div class="p-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="font-bold text-xl text-red-600 dark:text-red-400 mb-2 sm:mb-0">Clientes Cadastrados</h3>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button id="export-customers-csv" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button id="export-customers-excel" class="bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md card">
                        <div class="mb-4">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="customer-search" class="w-full p-3 pl-10 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Buscar cliente por nome ou telefone...">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b-2 border-red-200 dark:border-red-800">
                                        <th class="py-3 text-left">Nome</th>
                                        <th class="py-3 text-left">Telefone</th>
                                        <th class="py-3 text-left">Endere√ßo</th>
                                        <th class="py-3 text-center">Pedidos</th>
                                        <th class="py-3 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-8 text-gray-500">Nenhum cliente cadastrado.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja Card√°pio -->
            <div id="page-admin-menu" class="page">
                <div class="p-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="font-bold text-xl text-red-600 dark:text-red-400 mb-2 sm:mb-0">Gerenciar Card√°pio</h3>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button id="add-category" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-folder-plus"></i> Categoria
                            </button>
                            <button id="manage-extras" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-plus-circle"></i> Acr√©scimos
                            </button>
                            <button id="add-menu-item" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded text-sm transition duration-300 btn flex-1 sm:flex-none">
                                <i class="fas fa-plus"></i> Adicionar Item
                            </button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md card">
                        <div id="menu-management">
                            <!-- Menu categories and items will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Loja ImpulseAI -->
            <div id="page-admin-impulse" class="page">
                <div class="p-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="font-bold text-xl text-red-600 dark:text-red-400 mb-2 sm:mb-0">ImpulseAI - Comiss√µes</h3>
                        <div>
                            <button id="export-commissions-excel" class="bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded text-sm transition duration-300 btn">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o das Comiss√µes -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <h4 class="font-bold mb-3 text-red-600 dark:text-red-400">Configura√ß√£o de Comiss√µes</h4>
                        <div class="mb-4">
                            <label class="block mb-2 font-medium">Comiss√£o Padr√£o (%)</label>
                            <div class="flex space-x-2">
                                <input type="number" id="default-commission" class="p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" min="0" max="100" value="5">
                                <button id="apply-commission" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn">
                                    <i class="fas fa-check mr-1"></i> Aplicar
                                </button>
                            </div>
                        </div>
                        
                        <div id="commission-categories" class="space-y-3">
                            <!-- Categorias para comiss√µes personalizadas aqui -->
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas de Comiss√µes -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <h4 class="font-bold text-red-600 dark:text-red-400 mb-2 sm:mb-0">Estat√≠sticas de Comiss√µes</h4>
                            <div>
                                <select id="commission-period" class="p-2 border rounded text-sm bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input">
                                    <option value="day">Hoje</option>
                                    <option value="week">Esta Semana</option>
                                    <option value="month" selected>Este M√™s</option>
                                    <option value="year">Este Ano</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-4 bg-red-100 dark:bg-red-900 rounded transform transition duration-300 hover:scale-105">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Total de Vendas</p>
                                <p id="commission-sales" class="text-2xl font-bold text-red-600 dark:text-red-400">R$ 0,00</p>
                            </div>
                            <div class="text-center p-4 bg-yellow-100 dark:bg-yellow-900 rounded transform transition duration-300 hover:scale-105">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Total de Comiss√µes</p>
                                <p id="commission-total" class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">R$ 0,00</p>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico de Comiss√µes -->
                        <h5 class="font-medium mb-3 text-red-500 dark:text-red-300">Comiss√µes por Categoria</h5>
                        <div id="commission-chart" class="chart-container border-t border-gray-200 dark:border-gray-700 pt-6">
                            <!-- Barras do gr√°fico ser√£o inseridas aqui -->
                        </div>
                    </div>
                    
                    <!-- Hist√≥rico de Comiss√µes -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md card">
                        <h4 class="font-bold mb-3 text-red-600 dark:text-red-400">Hist√≥rico de Comiss√µes</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b-2 border-red-200 dark:border-red-800">
                                        <th class="py-3 text-left">Data</th>
                                        <th class="py-3 text-left">Pedido</th>
                                        <th class="py-3 text-left">Cliente</th>
                                        <th class="py-3 text-right">Valor</th>
                                        <th class="py-3 text-right">Comiss√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="commission-history">
                                    <tr>
                                        <td colspan="5" class="text-center py-8 text-gray-500">Nenhuma comiss√£o registrada.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√ÅGINA: Configura√ß√µes -->
            <div id="page-admin-settings" class="page">
                <div class="p-4">
                    <div class="mb-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-red-600 dark:text-red-400">Configura√ß√µes do Sistema</h2>
                    </div>

                    <!-- Taxa de Entrega (NOVO) -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-red-600 dark:text-red-400">Taxa de Entrega</h3>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="delivery-fee-enabled" class="form-checkbox h-5 w-5 text-red-600 transition duration-150 ease-in-out">
                                    <span class="ml-2">Ativar taxa de entrega</span>
                                </label>
                            </div>
                            <div id="delivery-fee-options" class="pt-3 space-y-3">
                                <div>
                                    <label for="delivery-fee-amount" class="block mb-2 font-medium">Valor da Taxa (R$)</label>
                                    <input type="number" id="delivery-fee-amount" min="0" step="0.01" class="w-full sm:w-1/3 p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="delivery-fee-min-order" class="block mb-2 font-medium">Pedido m√≠nimo para entrega gratuita (opcional)</label>
                                    <input type="number" id="delivery-fee-min-order" min="0" step="0.01" class="w-full sm:w-1/3 p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="0.00">
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Deixe em branco ou zero para n√£o oferecer entrega gratuita</p>
                                </div>
                                <div class="pt-2">
                                    <button id="save-delivery-settings" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn">
                                        <i class="fas fa-save mr-1"></i> Salvar Configura√ß√µes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Acr√©scimos Padr√£o (NOVO) -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md mb-5 card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-red-600 dark:text-red-400">Gerenciar Categoria</h3>
                            <button id="open-extras-manager" class="text-red-500 hover:text-red-700 transition duration-300 transform hover:scale-110">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 mb-3">Configure as categorias dispon√≠veis para os itens do card√°pio.</p>
                        <div id="extras-summary" class="space-y-2">
                            <p id="extras-count" class="font-medium">Nenhuma categoria cadastrada</p>
                            <button id="manage-extras-settings" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn">
                                <i class="fas fa-plus-circle mr-1"></i> Gerenciar Categoria
                            </button>
                        </div>
                    </div>

                    <!-- Apar√™ncia do App -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow-md card">
                        <h3 class="font-bold mb-3 text-red-600 dark:text-red-400">Apar√™ncia</h3>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="dark-mode-toggle" class="form-checkbox h-5 w-5 text-red-600 transition duration-150 ease-in-out">
                                    <span class="ml-2">Modo escuro</span>
                                </label>
                            </div>
                            <div>
                                <label class="block mb-2 font-medium">Modo padr√£o do aplicativo</label>
                                <div class="space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="default-app-mode" value="admin" class="form-radio h-5 w-5 text-red-600">
                                        <span class="ml-2">Administra√ß√£o</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="default-app-mode" value="client" checked class="form-radio h-5 w-5 text-red-600">
                                        <span class="ml-2">Cliente</span>
                                    </label>
                                </div>
                            </div>
                            <div class="pt-2">
                                <button id="save-appearance-settings" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn">
                                    <i class="fas fa-save mr-1"></i> Salvar Prefer√™ncias
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar (Hidden by default) -->
    <div id="cart-sidebar" class="fixed top-0 right-0 bottom-0 bg-white dark:bg-gray-800 shadow-lg w-4/5 sm:w-80 transform translate-x-full transition-transform duration-500 ease-in-out z-50 flex flex-col">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold text-red-600 dark:text-red-400">Seu Pedido</h3>
            <button id="close-cart" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 transition-transform duration-300 hover:rotate-90">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-4">
            <!-- Cart items will be inserted here -->
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <div id="delivery-fee-section" class="hidden flex justify-between mb-2">
                <span class="text-sm">Taxa de Entrega:</span>
                <span id="cart-delivery-fee" class="text-sm font-medium text-red-600 dark:text-red-400">R$ 0,00</span>
            </div>
            <div class="flex justify-between mb-4">
                <span class="font-bold">Total:</span>
                <span id="cart-total" class="font-bold text-red-600 dark:text-red-400">R$ 0,00</span>
            </div>
            <button id="checkout-button" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg transition duration-300 transform hover:scale-105 btn">
                <i class="fas fa-check-circle mr-2"></i> Finalizar Pedido
            </button>
        </div>
    </div>

    <!-- Print Preview Modal (Hidden by default) -->
    <div id="print-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl transform transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-600">Pr√©-visualiza√ß√£o de Impress√£o</h3>
                <button id="close-print-modal" class="text-gray-500 hover:text-gray-700 transition-transform duration-300 hover:rotate-90">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="print-content" class="print-receipt border p-4 mx-auto mb-4 overflow-auto max-h-80 rounded"></div>
            <div class="flex justify-end space-x-2">
                <button id="download-receipt" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn">
                    <i class="fas fa-download mr-1"></i> Salvar PDF
                </button>
                <button id="print-receipt" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded transition duration-300 btn">
                    <i class="fas fa-print mr-1"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Lookup Modal (Hidden by default) -->
    <div id="lookup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-2xl transform transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-600 dark:text-red-400">Buscar cliente por WhatsApp</h3>
                <button id="close-lookup-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 transition-transform duration-300 hover:rotate-90">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="relative">
                    <i class="fas fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="tel" id="lookup-phone" class="w-full p-3 pl-10 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="(00) 00000-0000">
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-lookup" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition duration-300 btn">
                    Cancelar
                </button>
                <button id="confirm-lookup" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded transition duration-300 btn">
                    <i class="fas fa-search mr-1"></i> Buscar
                </button>
            </div>
        </div>
    </div>

    <!-- Extras Modal (Hidden by default) -->
    <div id="extras-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-2xl transform transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-600 dark:text-red-400">Escolha os Acr√©scimos</h3>
                <button id="close-extras-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 transition-transform duration-300 hover:rotate-90">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Selecione os acr√©scimos para adicionar ao seu item:</p>
                <div id="extras-list" class="space-y-2 max-h-60 overflow-y-auto p-2">
                    <!-- Extras checkboxes will be dynamically added here -->
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-extras" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition duration-300 btn">
                    Cancelar
                </button>
                <button id="confirm-extras" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded transition duration-300 btn">
                    <i class="fas fa-shopping-cart mr-1"></i> Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Extras Modal (Hidden by default) -->
    <div id="manage-extras-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-2xl transform transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-600 dark:text-red-400">Gerenciar Acr√©scimos</h3>
                <button id="close-manage-extras" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 transition-transform duration-300 hover:rotate-90">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-extra-name" class="flex-1 p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Nome do acr√©scimo">
                    <input type="number" id="new-extra-price" class="w-24 p-3 border rounded text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" placeholder="Pre√ßo" step="0.01" min="0">
                    <button id="add-extra-item" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded transition duration-300 btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="extras-management-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Existing extras will be listed here -->
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button id="save-extras" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded transition duration-300 btn">
                    <i class="fas fa-save mr-1"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- Share App Modal (Hidden by default) -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-filter backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-2xl transform transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-red-600 dark:text-red-400">Compartilhar Marcos</h3>
                <button id="close-share-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 transition-transform duration-300 hover:rotate-90">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-6">
                <p class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4">Compartilhe o link de atendimento do Marcos com seus clientes:</p>
                <div class="flex justify-center mb-6">
                    <div id="qrcode" class="bg-white p-4 rounded shadow-md"></div>
                </div>
                <div class="flex mb-4">
                    <input type="text" id="share-link" class="flex-1 p-3 border rounded-l text-base bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600 form-input" readonly>
                    <button id="copy-link" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-r transition duration-300 btn">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="share-options space-y-2">
                    <a href="#" id="share-whatsapp" class="text-gray-700 dark:text-gray-300 block rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-500 dark:hover:border-green-500 p-3">
                        <i class="fab fa-whatsapp text-green-500 text-xl"></i> Compartilhar via WhatsApp
                    </a>
                    <a href="#" id="share-telegram" class="text-gray-700 dark:text-gray-300 block rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-500 p-3">
                        <i class="fab fa-telegram text-blue-500 text-xl"></i> Compartilhar via Telegram
                    </a>
                    <button id="share-custom" class="text-gray-700 dark:text-gray-300 block w-full text-left rounded-lg border border-gray-200 dark:border-gray-700 hover:border-red-500 dark:hover:border-red-500 p-3">
                        <i class="fas fa-share-alt text-red-500 text-xl"></i> Compartilhar em outras plataformas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Special Promotion Banner (MODIFICADO: adicionado bot√£o de fechar) -->
    <div class="fixed bottom-4 left-4 right-4 bg-gradient-to-r from-red-500 to-yellow-500 text-white p-3 rounded-lg shadow-lg z-40 flex justify-between items-center sm:max-w-sm sm:mx-auto" id="promotion-banner">
        <div>
            <span class="font-bold">üçî Promo√ß√£o do Dia!</span>
            <p class="text-sm">Pe√ßa agora e ganhe 10% OFF</p>
        </div>
        <div class="flex items-center">
            <i class="fas fa-hamburger text-2xl food-icon mr-3"></i>
            <button id="close-promotion" class="text-white hover:text-gray-200 transition-all duration-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification flex items-center">
        <i class="fas fa-bell mr-2"></i>
        <span id="notification-text"></span>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Armazenamento em mem√≥ria como alternativa ao localStorage
        const memoryStorage = {
            customers: [],
            orders: [],
            menuData: {
                "Lanches": [
                    { id: 1, name: "X-Burguer", price: 15.00, description: "P√£o, hamb√∫rguer, queijo, alface, tomate" },
                    { id: 2, name: "X-Salada", price: 17.00, description: "P√£o, hamb√∫rguer, queijo, alface, tomate, cebola" },
                    { id: 3, name: "X-Bacon", price: 18.50, description: "P√£o, hamb√∫rguer, queijo, bacon, alface, tomate" },
                    { id: 4, name: "X-Tudo", price: 22.00, description: "P√£o, hamb√∫rguer, queijo, bacon, ovo, alface, tomate, cebola" }
                ],
                "Por√ß√µes": [
                    { id: 5, name: "Batata Frita", price: 12.00, description: "Por√ß√£o de batata frita crocante" },
                    { id: 6, name: "An√©is de Cebola", price: 15.00, description: "Por√ß√£o de an√©is de cebola empanados" },
                    { id: 7, name: "Isca de Frango", price: 18.00, description: "Por√ß√£o de isca de frango empanado" }
                ],
                "Bebidas": [
                    { id: 8, name: "Refrigerante (Lata)", price: 6.00, description: "Coca-Cola, Guaran√°, Sprite" },
                    { id: 9, name: "Suco Natural", price: 8.00, description: "Laranja, Abacaxi, Maracuj√°" },
                    { id: 10, name: "√Ågua Mineral", price: 4.00, description: "√Ågua mineral sem g√°s" }
                ]
            },
            extrasData: [
                { id: 1, name: "Queijo Extra", price: 3.00 },
                { id: 2, name: "Bacon", price: 4.00 },
                { id: 3, name: "Ovo", price: 2.00 },
                { id: 4, name: "Cheddar", price: 3.50 },
                { id: 5, name: "Calabresa", price: 3.50 },
                { id: 6, name: "Cebola Caramelizada", price: 2.50 }
            ],
            orderNumber: 1,
            adminUsers: [
                {
                    email: "admin@marcos.com",
                    password: "admin123",
                    name: "Marcos",
                    address: "Rua das Palmeiras, 123",
                    phone: "(11) 99999-9999"
                }
            ],
            restaurantInfo: {
                name: "Marcos",
                address: "Rua das Palmeiras, 123",
                phone: "(11) 99999-9999"
            },
            commissionRates: {
                default: 5,
                categories: {
                    "Lanches": 7,
                    "Por√ß√µes": 6,
                    "Bebidas": 4
                }
            },
            loggedInUser: null,
            newOrderIndicator: null,
            promotionData: {
                status: 'active',
                title: 'üçî Promo√ß√£o do Dia!',
                text: 'Pe√ßa agora e ganhe 10% OFF'
            },
            // Nova configura√ß√£o para taxa de entrega
            deliveryFee: {
                enabled: false,
                amount: 5.00,
                freeDeliveryMinimum: 50.00
            },
            // Configura√ß√µes de apar√™ncia
            appSettings: {
                darkMode: false,
                defaultMode: 'client'  // 'client' ou 'admin'
            }
        };

        // Storage functions - now using memoryStorage instead of localStorage
        function saveToStorage(key, data) {
            try {
                // Tenta usar localStorage, mas se falhar, usa memoryStorage
                try {
                    localStorage.setItem(`marcos-app-${key}`, JSON.stringify(data));
                } catch (error) {
                    // Se o localStorage falhar, usa o armazenamento em mem√≥ria
                    memoryStorage[key] = JSON.parse(JSON.stringify(data)); // Deep copy
                }
                return true;
            } catch (error) {
                console.log(`Armazenando ${key} na mem√≥ria`);
                return false;
            }
        }
        
        function getFromStorage(key, defaultValue = null) {
            try {
                // Tenta buscar do localStorage
                try {
                    const data = localStorage.getItem(`marcos-app-${key}`);
                    if (data) {
                        return JSON.parse(data);
                    }
                } catch (error) {
                    // Ignora erros de localStorage
                }
                
                // Se n√£o encontrar no localStorage ou der erro, usa o memoryStorage
                if (memoryStorage[key] !== undefined) {
                    return JSON.parse(JSON.stringify(memoryStorage[key])); // Deep copy
                }
                
                return defaultValue;
            } catch (error) {
                console.log(`Obtendo ${key} da mem√≥ria`);
                return defaultValue;
            }
        }
        
        // Menu data
        const menuData = getFromStorage('menuData', memoryStorage.menuData);

        // Dados de acr√©scimos
        const extrasData = getFromStorage('extrasData', memoryStorage.extrasData);
        
        // In-memory store for orders, users, and customer data
        let customers = getFromStorage('customers', []);
        let orders = getFromStorage('orders', []);
        let cart = [];
        let currentOrderNumber = getFromStorage('orderNumber', 1);
        let loggedIn = false;
        let adminUsers = getFromStorage('adminUsers', memoryStorage.adminUsers);
        let restaurantInfo = getFromStorage('restaurantInfo', memoryStorage.restaurantInfo);
        let currentCustomer = null;
        let selectedItem = null;
        let selectedExtras = [];
        let commissionRates = getFromStorage('commissionRates', memoryStorage.commissionRates);
        let promotionData = getFromStorage('promotionData', memoryStorage.promotionData);
        // Nova configura√ß√£o para taxa de entrega
        let deliveryFee = getFromStorage('deliveryFee', memoryStorage.deliveryFee);
        // Configura√ß√µes de apar√™ncia
        let appSettings = getFromStorage('appSettings', memoryStorage.appSettings);
        
        // Set up periodic check for new orders
        let lastOrdersCheck = 0;

        // Chat bot conversation flow
        let currentStep = 'welcome';
        let customerData = {
            name: '',
            address: '',
            phone: '',
            deliveryMethod: '',
            paymentMethod: '',
            orderNotes: ''
        };

        // Routing System
        let currentPage = 'client';

        // DOM Elements - Using safe access patterns with null checks
        function getElementById(id) {
            const el = document.getElementById(id);
            if (!el) console.warn(`Element with id '${id}' not found`);
            return el;
        }

        // Client page elements
        const clientSignin = getElementById('client-signin');
        const clientChat = getElementById('client-chat');
        const customerName = getElementById('customer-name');
        const customerPhone = getElementById('customer-phone');
        const customerAddress = getElementById('customer-address');
        const customerLogin = getElementById('customer-login');
        const findByPhone = getElementById('find-by-phone');
        const lookupModal = getElementById('lookup-modal');
        const lookupPhone = getElementById('lookup-phone');
        const closeLookupModal = getElementById('close-lookup-modal');
        const cancelLookup = getElementById('cancel-lookup');
        const confirmLookup = getElementById('confirm-lookup');
        
        const chatContainer = getElementById('chat-container');
        const optionsContainer = getElementById('options-container');
        const messageInput = getElementById('message-input');
        const sendButton = getElementById('send-button');
        
        const cartSidebar = getElementById('cart-sidebar');
        const cartItems = getElementById('cart-items');
        const cartTotal = getElementById('cart-total');
        const cartCount = getElementById('cart-count');
        const toggleCart = getElementById('toggle-cart');
        const closeCart = getElementById('close-cart');
        const checkoutButton = getElementById('checkout-button');

        // Elementos da taxa de entrega (NOVOS)
        const cartDeliveryFeeSection = getElementById('delivery-fee-section');
        const cartDeliveryFee = getElementById('cart-delivery-fee');
        const deliveryFeeEnabled = getElementById('delivery-fee-enabled');
        const deliveryFeeAmount = getElementById('delivery-fee-amount');
        const deliveryFeeMinOrder = getElementById('delivery-fee-min-order');
        const deliveryFeeOptions = getElementById('delivery-fee-options');
        const saveDeliverySettings = getElementById('save-delivery-settings');

        // Navigation buttons
        const btnClient = getElementById('btn-client');
        const btnAdmin = getElementById('btn-admin');
        const btnRegister = getElementById('btn-register');
        const cartButtonContainer = getElementById('cart-button-container');
        const adminNavbar = getElementById('admin-navbar');
        
        // Admin nav links
        const navDashboard = getElementById('nav-dashboard');
        const navOrders = getElementById('nav-orders');
        const navCustomers = getElementById('nav-customers');
        const navMenu = getElementById('nav-menu');
        const navImpulse = getElementById('nav-impulse');
        const navSettings = getElementById('nav-settings');
        
        // Admin form elements
        const adminLoginButton = getElementById('admin-login-button');
        const adminEmail = getElementById('admin-email');
        const adminPassword = getElementById('admin-password');
        const backToLogin = getElementById('back-to-login');
        const completeRegister = getElementById('complete-register');
        const adminLogout = getElementById('admin-logout');
        
        const notification = getElementById('notification');
        const notificationText = getElementById('notification-text');
        
        const ordersContainer = getElementById('orders-container');
        const noOrdersMessage = getElementById('no-orders-message');
        const recentOrders = getElementById('recent-orders');
        const noRecentOrders = getElementById('no-recent-orders');
        const viewAllOrders = getElementById('view-all-orders');
        
        const customersTableBody = getElementById('customers-table-body');
        const customerSearch = getElementById('customer-search');
        
        const printModal = getElementById('print-modal');
        const printContent = getElementById('print-content');
        const closePrintModal = getElementById('close-print-modal');
        const printReceipt = getElementById('print-receipt');
        const downloadReceipt = getElementById('download-receipt');
        
        const extrasModal = getElementById('extras-modal');
        const extrasList = getElementById('extras-list');
        const closeExtrasModal = getElementById('close-extras-modal');
        const cancelExtras = getElementById('cancel-extras');
        const confirmExtras = getElementById('confirm-extras');
        
        const manageExtrasModal = getElementById('manage-extras-modal');
        const closeManageExtras = getElementById('close-manage-extras');
        const newExtraName = getElementById('new-extra-name');
        const newExtraPrice = getElementById('new-extra-price');
        const addExtraItem = getElementById('add-extra-item');
        const extrasManagementList = getElementById('extras-management-list');
        const saveExtras = getElementById('save-extras');
        const manageExtras = getElementById('manage-extras');
        const manageExtrasSettings = getElementById('manage-extras-settings');
        const openExtrasManager = getElementById('open-extras-manager');
        const extrasCount = getElementById('extras-count');
        
        const filterDate = getElementById('filter-date');
        const applyFilter = getElementById('apply-filter');
        const clearFilter = getElementById('clear-filter');
        
        const exportOrdersCsv = getElementById('export-orders-csv');
        const exportOrdersExcel = getElementById('export-orders-excel');
        const exportCustomersCsv = getElementById('export-customers-csv');
        const exportCustomersExcel = getElementById('export-customers-excel');
        const exportCommissionsExcel = getElementById('export-commissions-excel');
        
        const statsOrders = getElementById('stats-orders');
        const statsTotal = getElementById('stats-total');
        const statsPix = getElementById('stats-pix');
        const statsCard = getElementById('stats-card');
        const statsCash = getElementById('stats-cash');
        
        const defaultCommission = getElementById('default-commission');
        const applyCommission = getElementById('apply-commission');
        const commissionCategories = getElementById('commission-categories');
        const commissionPeriod = getElementById('commission-period');
        const commissionSales = getElementById('commission-sales');
        const commissionTotal = getElementById('commission-total');
        const commissionChart = getElementById('commission-chart');
        const commissionHistory = getElementById('commission-history');
        
        const editInfoButton = getElementById('edit-info-button');
        const restaurantInfoDiv = getElementById('restaurant-info');
        const editInfoForm = getElementById('edit-info-form');
        const cancelEdit = getElementById('cancel-edit');
        const saveInfo = getElementById('save-info');
        const editName = getElementById('edit-name');
        const editAddress = getElementById('edit-address');
        const editPhone = getElementById('edit-phone');
        const infoName = getElementById('info-name');
        const infoAddress = getElementById('info-address');
        const infoPhone = getElementById('info-phone');
        
        // Promotion elements
        const promotionBanner = getElementById('promotion-banner');
        const closePromotion = getElementById('close-promotion');
        const editPromoButton = getElementById('edit-promo-button');
        const promotionInfo = getElementById('promotion-info');
        const editPromoForm = getElementById('edit-promo-form');
        const cancelPromoEdit = getElementById('cancel-promo-edit');
        const savePromo = getElementById('save-promo');
        const editPromoStatus = getElementById('edit-promo-status');
        const editPromoTitle = getElementById('edit-promo-title');
        const editPromoText = getElementById('edit-promo-text');
        const promoStatus = getElementById('promo-status');
        const promoTitle = getElementById('promo-title');
        const promoText = getElementById('promo-text');
        
        // Appearance settings
        const darkModeToggle = getElementById('dark-mode-toggle');
        const defaultAppModeRadios = document.getElementsByName('default-app-mode');
        const saveAppearanceSettings = getElementById('save-appearance-settings');
        
        const menuManagement = getElementById('menu-management');
        const addMenuItem = getElementById('add-menu-item');
        const addCategory = getElementById('add-category');
        
        const shareApp = getElementById('share-app');
        const shareModal = getElementById('share-modal');
        const closeShareModal = getElementById('close-share-modal');
        const qrcodeContainer = getElementById('qrcode');
        const shareLink = getElementById('share-link');
        const copyLink = getElementById('copy-link');
        const shareWhatsapp = getElementById('share-whatsapp');
        const shareTelegram = getElementById('share-telegram');
        const shareCustom = getElementById('share-custom');
        
        // Password strength meter
        const passwordStrength = getElementById('password-strength');
        const registerPassword = getElementById('register-password');

        // ================ ROUTER ================
        
        // Router function to change pages
        function navigateTo(page) {
            try {
                console.log(`Navigating to page: ${page}`);
                // Hide all pages first
                document.querySelectorAll('.page').forEach(pageElement => {
                    pageElement.classList.remove('active');
                });
                
                // Show the requested page
                const targetPage = document.getElementById('page-' + page);
                if (targetPage) {
                    targetPage.classList.add('active');
                    currentPage = page;
                    
                    // Update URL
                    const url = new URL(window.location);
                    url.searchParams.set('page', page);
                    window.history.pushState({}, '', url);
                    
                    // Update navigation state
                    updateNavigationState(page);
                    
                    // Special case handling
                    if (page === 'admin-dashboard' || page === 'admin-orders' || 
                        page === 'admin-customers' || page === 'admin-menu' || 
                        page === 'admin-impulse' || page === 'admin-settings') {
                        
                        // Check if user is logged in
                        if (!loggedIn) {
                            showNotification("Por favor, fa√ßa login primeiro!");
                            navigateTo('admin-login');
                            return;
                        }
                        
                        // Update data based on page
                        if (page === 'admin-dashboard') {
                            updateStats();
                            updateRecentOrders();
                            updatePromotionDisplay();
                        } else if (page === 'admin-orders') {
                            updateOrdersList();
                        } else if (page === 'admin-customers') {
                            updateCustomersList();
                        } else if (page === 'admin-menu') {
                            renderMenuManagement();
                        } else if (page === 'admin-impulse') {
                            updateCommissionData();
                        } else if (page === 'admin-settings') {
                            // Inicializar campos de configura√ß√£o
                            initSettingsPage();
                        }
                    }
                    
                    // Show/hide cart button based on page
                    if (cartButtonContainer) {
                        cartButtonContainer.classList.toggle('hidden', !page.startsWith('client'));
                    }
                } else {
                    console.error(`Page ${page} not found!`);
                    // Fallback to client page
                    navigateTo('client');
                }
            } catch (error) {
                console.error("Navigation error:", error);
                showNotification("Ocorreu um erro na navega√ß√£o");
            }
        }
        
        // Update navigation state based on current page
        function updateNavigationState(page) {
            try {
                // Update main navigation buttons
                if (btnClient) {
                    btnClient.classList.toggle('bg-red-500', page.startsWith('client'));
                    btnClient.classList.toggle('text-white', page.startsWith('client'));
                    btnClient.classList.toggle('bg-gray-300', !page.startsWith('client'));
                    btnClient.classList.toggle('text-gray-700', !page.startsWith('client'));
                }
                
                if (btnAdmin) {
                    btnAdmin.classList.toggle('bg-red-500', page === 'admin-login' || page.startsWith('admin-') && page !== 'admin-register');
                    btnAdmin.classList.toggle('text-white', page === 'admin-login' || page.startsWith('admin-') && page !== 'admin-register');
                    btnAdmin.classList.toggle('bg-gray-300', !(page === 'admin-login' || page.startsWith('admin-') && page !== 'admin-register'));
                    btnAdmin.classList.toggle('text-gray-700', !(page === 'admin-login' || page.startsWith('admin-') && page !== 'admin-register'));
                }
                
                if (btnRegister) {
                    btnRegister.classList.toggle('bg-yellow-500', page === 'admin-register');
                    btnRegister.classList.toggle('text-white', page === 'admin-register');
                    btnRegister.classList.toggle('bg-gray-300', page !== 'admin-register');
                    btnRegister.classList.toggle('text-gray-700', page !== 'admin-register');
                }
                
                // Show/hide admin navbar
                if (adminNavbar) {
                    adminNavbar.classList.toggle('hidden', !page.startsWith('admin-') || page === 'admin-login' || page === 'admin-register');
                }
                
                // Update admin navigation links
                if (page.startsWith('admin-') && page !== 'admin-login' && page !== 'admin-register') {
                    document.querySelectorAll('.shop-nav-link').forEach(link => {
                        link.classList.remove('border-red-500', 'text-red-600', 'dark:text-red-400', 'font-medium', 'active');
                    });
                    
                    const activeNavLink = document.getElementById('nav-' + page.substring(6)); // Remove 'admin-' prefix
                    if (activeNavLink) {
                        activeNavLink.classList.add('border-red-500', 'text-red-600', 'dark:text-red-400', 'font-medium', 'active');
                    }
                }
            } catch (error) {
                console.error("Error updating navigation state:", error);
            }
        }
        
        // Initialize the router
        function initRouter() {
            try {
                console.log("Initializing router");
                // Parse URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page') || (appSettings.defaultMode === 'admin' && loggedIn ? 'admin-dashboard' : 'client');
                
                // Set up navigation event listeners
                if (btnClient) {
                    btnClient.addEventListener('click', () => navigateTo('client'));
                }
                
                if (btnAdmin) {
                    btnAdmin.addEventListener('click', () => {
                        if (loggedIn) {
                            navigateTo('admin-dashboard');
                        } else {
                            navigateTo('admin-login');
                        }
                    });
                }
                
                if (btnRegister) {
                    btnRegister.addEventListener('click', () => {
                        navigateTo('admin-register');
                    });
                }
                
                // Admin navigation
                if (navDashboard) {
                    navDashboard.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('admin-dashboard');
                    });
                }
                
                if (navOrders) {
                    navOrders.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('admin-orders');
                    });
                }
                
                if (navCustomers) {
                    navCustomers.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('admin-customers');
                    });
                }
                
                if (navMenu) {
                    navMenu.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('admin-menu');
                    });
                }
                
                if (navImpulse) {
                    navImpulse.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('admin-impulse');
                    });
                }
                
                if (navSettings) {
                    navSettings.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo('admin-settings');
                    });
                }
                
                // Handle back/forward buttons
                window.addEventListener('popstate', () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const page = urlParams.get('page') || 'client';
                    navigateTo(page);
                });
                
                // Navigate to the initial page
                navigateTo(page);
                console.log("Router initialized, navigated to:", page);
            } catch (error) {
                console.error("Router initialization error:", error);
            }
        }

        // Novo bot√£o de adicionar categoria
        if (addCategory) {
            addCategory.addEventListener('click', () => {
                const categoryName = prompt('Digite o nome da nova categoria:');
                if (categoryName && categoryName.trim() !== '') {
                    if (!menuData[categoryName]) {
                        menuData[categoryName] = [];
                        // Salvar o card√°pio atualizado
                        saveToStorage('menuData', menuData);
                        renderMenuManagement();
                        showNotification(`Categoria "${categoryName}" adicionada!`);
                    } else {
                        showNotification(`A categoria "${categoryName}" j√° existe!`);
                    }
                }
            });
        }

        // =========== P√ÅGINA DE CONFIGURA√á√ïES (NOVO) ============

        // Inicializa a p√°gina de configura√ß√µes
        function initSettingsPage() {
            // Configura√ß√µes de taxa de entrega
            if (deliveryFeeEnabled) {
                deliveryFeeEnabled.checked = deliveryFee.enabled;
                
                if (deliveryFeeAmount) {
                    deliveryFeeAmount.value = deliveryFee.amount.toFixed(2);
                }
                
                if (deliveryFeeMinOrder) {
                    deliveryFeeMinOrder.value = deliveryFee.freeDeliveryMinimum > 0 ? 
                        deliveryFee.freeDeliveryMinimum.toFixed(2) : '';
                }
                
                // Mostra/esconde as op√ß√µes da taxa de entrega
                if (deliveryFeeOptions) {
                    deliveryFeeOptions.style.display = deliveryFee.enabled ? 'block' : 'none';
                }
            }
            
            // Configura√ß√µes de apar√™ncia
            if (darkModeToggle) {
                darkModeToggle.checked = document.documentElement.classList.contains('dark');
            }
            
            if (defaultAppModeRadios) {
                for (let radio of defaultAppModeRadios) {
                    if (radio.value === appSettings.defaultMode) {
                        radio.checked = true;
                    }
                }
            }
            
            // Atualiza contadores de acr√©scimos
            updateExtrasCount();
        }

        // Toggle para mostrar/esconder op√ß√µes de taxa de entrega
        if (deliveryFeeEnabled) {
            deliveryFeeEnabled.addEventListener('change', function() {
                if (deliveryFeeOptions) {
                    deliveryFeeOptions.style.display = this.checked ? 'block' : 'none';
                }
            });
        }

        // Salvar configura√ß√µes de taxa de entrega
        if (saveDeliverySettings) {
            saveDeliverySettings.addEventListener('click', function() {
                if (!deliveryFeeEnabled || !deliveryFeeAmount) return;
                
                deliveryFee.enabled = deliveryFeeEnabled.checked;
                deliveryFee.amount = parseFloat(deliveryFeeAmount.value) || 0;
                deliveryFee.freeDeliveryMinimum = deliveryFeeMinOrder ? parseFloat(deliveryFeeMinOrder.value) || 0 : 0;
                
                saveToStorage('deliveryFee', deliveryFee);
                showNotification("Configura√ß√µes de entrega salvas com sucesso!");
            });
        }

        // Salvar configura√ß√µes de apar√™ncia
        if (saveAppearanceSettings) {
            saveAppearanceSettings.addEventListener('click', function() {
                if (!darkModeToggle) return;
                
                // Configura√ß√£o do modo escuro
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // Configura√ß√£o do modo padr√£o da aplica√ß√£o
                let defaultMode = 'client';
                for (let radio of defaultAppModeRadios) {
                    if (radio.checked) {
                        defaultMode = radio.value;
                        break;
                    }
                }
                
                appSettings.darkMode = darkModeToggle.checked;
                appSettings.defaultMode = defaultMode;
                
                saveToStorage('appSettings', appSettings);
                showNotification("Prefer√™ncias de apar√™ncia salvas com sucesso!");
            });
        }

        // Atualiza o contador de acr√©scimos
        function updateExtrasCount() {
            if (extrasCount) {
                if (extrasData.length === 0) {
                    extrasCount.textContent = "Nenhum acr√©scimo cadastrado";
                } else {
                    extrasCount.textContent = `${extrasData.length} acr√©scimo(s) dispon√≠veis`;
                }
            }
        }

        // Abrir o gerenciador de acr√©scimos a partir das configura√ß√µes
        if (manageExtrasSettings) {
            manageExtrasSettings.addEventListener('click', function() {
                renderExtrasManagement();
                if (manageExtrasModal) manageExtrasModal.classList.remove('hidden');
            });
        }

        if (openExtrasManager) {
            openExtrasManager.addEventListener('click', function() {
                renderExtrasManagement();
                if (manageExtrasModal) manageExtrasModal.classList.remove('hidden');
            });
        }

        // ============ PROMO√á√ÉO DO DIA ============

        // Fechando a promo√ß√£o do dia
        if (closePromotion) {
            closePromotion.addEventListener('click', () => {
                if (promotionBanner) promotionBanner.classList.add('hidden');
            });
        }

        // Mostra/esconde a promo√ß√£o baseado no seu status e atualiza o texto
        function updatePromotionDisplay() {
            if (promoStatus) promoStatus.textContent = promotionData.status === 'active' ? 'Ativa' : 'Inativa';
            if (promoTitle) promoTitle.textContent = promotionData.title;
            if (promoText) promoText.textContent = promotionData.text;
            
            // Atualiza a promo√ß√£o na tela principal
            const bannerTitle = document.querySelector('#promotion-banner .font-bold');
            const bannerText = document.querySelector('#promotion-banner .text-sm');
            if (bannerTitle) bannerTitle.textContent = promotionData.title;
            if (bannerText) bannerText.textContent = promotionData.text;
            
            // Mostra/esconde baseado no status
            if (promotionBanner) {
                promotionBanner.classList.toggle('hidden', promotionData.status === 'inactive');
            }
        }

        // Editar a promo√ß√£o
        if (editPromoButton) {
            editPromoButton.addEventListener('click', () => {
                if (!editPromoStatus || !editPromoTitle || !editPromoText || !promotionInfo || !editPromoForm) return;
                
                editPromoStatus.value = promotionData.status;
                editPromoTitle.value = promotionData.title;
                editPromoText.value = promotionData.text;
                
                promotionInfo.classList.add('hidden');
                editPromoForm.classList.remove('hidden');
            });
        }

        if (cancelPromoEdit) {
            cancelPromoEdit.addEventListener('click', () => {
                if (!promotionInfo || !editPromoForm) return;
                
                promotionInfo.classList.remove('hidden');
                editPromoForm.classList.add('hidden');
            });
        }

        if (savePromo) {
            savePromo.addEventListener('click', () => {
                if (!editPromoStatus || !editPromoTitle || !editPromoText || !promotionInfo || !editPromoForm) return;
                
                promotionData.status = editPromoStatus.value;
                promotionData.title = editPromoTitle.value;
                promotionData.text = editPromoText.value;
                
                saveToStorage('promotionData', promotionData);
                updatePromotionDisplay();
                
                promotionInfo.classList.remove('hidden');
                editPromoForm.classList.add('hidden');
                
                showNotification("Promo√ß√£o atualizada com sucesso!");
            });
        }

        // ============ GERENCIAMENTO DE ACR√âSCIMOS ============

        // Abrir modal de gerenciamento de acr√©scimos
        if (manageExtras) {
            manageExtras.addEventListener('click', () => {
                renderExtrasManagement();
                if (manageExtrasModal) manageExtrasModal.classList.remove('hidden');
            });
        }

        if (closeManageExtras) {
            closeManageExtras.addEventListener('click', () => {
                if (manageExtrasModal) manageExtrasModal.classList.add('hidden');
            });
        }

        // Adicionar novo acr√©scimo
        if (addExtraItem) {
            addExtraItem.addEventListener('click', () => {
                if (!newExtraName || !newExtraPrice) return;
                
                const name = newExtraName.value.trim();
                const price = parseFloat(newExtraPrice.value);
                
                if (!name || isNaN(price)) {
                    showNotification("Digite um nome e pre√ßo v√°lidos!");
                    return;
                }
                
                const newExtra = {
                    id: extrasData.length > 0 ? Math.max(...extrasData.map(e => e.id)) + 1 : 1,
                    name: name,
                    price: price
                };
                
                extrasData.push(newExtra);
                renderExtrasManagement();
                
                newExtraName.value = '';
                newExtraPrice.value = '';
            });
        }

        // Salvar altera√ß√µes nos acr√©scimos
        if (saveExtras) {
            saveExtras.addEventListener('click', () => {
                if (manageExtrasModal) manageExtrasModal.classList.add('hidden');
                // Salvar os dados de acr√©scimos para persist√™ncia
                saveToStorage('extrasData', extrasData);
                updateExtrasCount();
                showNotification("Acr√©scimos atualizados com sucesso!");
            });
        }

        function renderExtrasManagement() {
            if (!extrasManagementList) return;
            
            extrasManagementList.innerHTML = '';
            
            if (extrasData.length === 0) {
                extrasManagementList.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum acr√©scimo cadastrado.</p>';
                return;
            }
            
            extrasData.forEach(extra => {
                const extraItem = document.createElement('div');
                extraItem.classList.add('flex', 'justify-between', 'items-center', 'bg-gray-50', 'dark:bg-gray-700', 'p-3', 'rounded', 'mb-3', 'transition-all', 'duration-300', 'hover:shadow-md');
                
                extraItem.innerHTML = `
                    <div>
                        <span class="font-medium">${extra.name}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="mr-3 text-red-600 dark:text-red-400 font-medium">R$ ${extra.price.toFixed(2)}</span>
                        <button class="edit-extra text-red-500 hover:text-red-700 mr-2 transition duration-300 transform hover:scale-110" data-id="${extra.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-extra text-red-500 hover:text-red-700 transition duration-300 transform hover:scale-110" data-id="${extra.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                extrasManagementList.appendChild(extraItem);
                
                // Adicionar event listeners para editar e excluir
                const editBtn = extraItem.querySelector('.edit-extra');
                const deleteBtn = extraItem.querySelector('.delete-extra');
                
                editBtn.addEventListener('click', () => {
                    const extraId = parseInt(editBtn.getAttribute('data-id'));
                    editExtra(extraId);
                });
                
                deleteBtn.addEventListener('click', () => {
                    const extraId = parseInt(deleteBtn.getAttribute('data-id'));
                    deleteExtra(extraId);
                });
            });
        }

        function editExtra(extraId) {
            if (!extrasManagementList) return;
            
            const extra = extrasData.find(e => e.id === extraId);
            if (!extra) return;
            
            const extraItem = document.querySelector(`.edit-extra[data-id="${extraId}"]`).closest('.flex');
            if (!extraItem) return;
            
            // Criar formul√°rio de edi√ß√£o
            const editForm = document.createElement('div');
            editForm.classList.add('flex', 'items-center', 'space-x-2', 'bg-red-50', 'dark:bg-red-900', 'p-3', 'rounded', 'mb-3');
            
            editForm.innerHTML = `
                <input type="text" class="edit-extra-name flex-1 p-2 border rounded text-base bg-white dark:bg-gray-600 dark:text-white form-input" value="${extra.name}">
                <input type="number" class="edit-extra-price w-24 p-2 border rounded text-base bg-white dark:bg-gray-600 dark:text-white form-input" value="${extra.price}" step="0.01" min="0">
                <button class="save-extra-edit bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded transition duration-300 transform hover:scale-105">
                    <i class="fas fa-check"></i>
                </button>
                <button class="cancel-extra-edit bg-gray-300 hover:bg-gray-400 text-gray-800 p-2 rounded transition duration-300 transform hover:scale-105">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Substituir o item pelo formul√°rio
            extraItem.replaceWith(editForm);
            
            // Adicionar event listeners
            const saveBtn = editForm.querySelector('.save-extra-edit');
            const cancelBtn = editForm.querySelector('.cancel-extra-edit');
            
            saveBtn.addEventListener('click', () => {
                const nameInput = editForm.querySelector('.edit-extra-name');
                const priceInput = editForm.querySelector('.edit-extra-price');
                
                extra.name = nameInput.value;
                extra.price = parseFloat(priceInput.value);
                
                // Salvar os dados de acr√©scimos para persist√™ncia
                saveToStorage('extrasData', extrasData);
                renderExtrasManagement();
            });
            
            cancelBtn.addEventListener('click', () => {
                renderExtrasManagement();
            });
        }

        function deleteExtra(extraId) {
            if (confirm('Tem certeza que deseja excluir este acr√©scimo?')) {
                const index = extrasData.findIndex(e => e.id === extraId);
                if (index !== -1) {
                    extrasData.splice(index, 1);
                    // Salvar os dados de acr√©scimos para persist√™ncia
                    saveToStorage('extrasData', extrasData);
                    renderExtrasManagement();
                }
            }
        }

        // ============ MODAL DE ACR√âSCIMOS PARA O CLIENTE ============

        function showExtrasModal(item) {
            if (!extrasModal || !extrasList) return;
            
            selectedItem = item;
            selectedExtras = [];
            
            // Preencher a lista de acr√©scimos dispon√≠veis
            extrasList.innerHTML = '';
            
            // Mostrar todos os acr√©scimos dispon√≠veis, n√£o apenas o primeiro
            if (extrasData.length > 0) {
                extrasData.forEach(extra => {
                    const extraItem = document.createElement('div');
                    extraItem.classList.add('checkbox-item');
                    
                    extraItem.innerHTML = `
                        <input type="checkbox" id="extra-${extra.id}" data-id="${extra.id}" class="extra-checkbox">
                        <label for="extra-${extra.id}" class="flex justify-between w-full">
                            <span>${extra.name}</span>
                            <span class="font-medium text-red-600 dark:text-red-400">+ R$ ${extra.price.toFixed(2)}</span>
                        </label>
                    `;
                    
                    extrasList.appendChild(extraItem);
                });
            } else {
                extrasList.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum acr√©scimo dispon√≠vel.</p>';
            }
            
            extrasModal.classList.remove('hidden');
        }

        if (closeExtrasModal) {
            closeExtrasModal.addEventListener('click', () => {
                if (extrasModal) extrasModal.classList.add('hidden');
            });
        }

        if (cancelExtras) {
            cancelExtras.addEventListener('click', () => {
                if (extrasModal) extrasModal.classList.add('hidden');
            });
        }

        if (confirmExtras) {
            confirmExtras.addEventListener('click', () => {
                if (!extrasModal || !selectedItem) return;
                
                // Coletar todos os acr√©scimos selecionados
                const checkboxes = document.querySelectorAll('.extra-checkbox:checked');
                
                selectedExtras = Array.from(checkboxes).map(checkbox => {
                    const extraId = parseInt(checkbox.getAttribute('data-id'));
                    return extrasData.find(e => e.id === extraId);
                }).filter(Boolean);
                
                // Adicionar ao carrinho com os acr√©scimos selecionados
                addToCartWithExtras(selectedItem, selectedExtras);
                
                extrasModal.classList.add('hidden');
                
                // Mostrar mensagem de confirma√ß√£o
                let extraItems = '';
                if (selectedExtras.length > 0) {
                    extraItems = ' com ' + selectedExtras.map(e => e.name).join(', ');
                }
                
                addBotMessage(`${selectedItem.name}${extraItems} adicionado ao carrinho!`);
                addBotMessage("Deseja adicionar mais algum item ao pedido?");
                currentStep = 'adding_items';
                
                showOptions([
                    { text: "Ver Card√°pio", value: "menu" },
                    { text: "Finalizar Pedido", value: "checkout" }
                ]);
            });
        }

        // ============ COMPARTILHAMENTO DA APLICA√á√ÉO ============

        if (shareApp) {
            shareApp.addEventListener('click', () => {
                if (!shareModal || !qrcodeContainer || !shareLink) return;
                
                // Gerar o link de compartilhamento (sem a parte de admin)
                const currentUrl = window.location.href.split('?')[0];
                const shareableLink = currentUrl + '?page=client';
                
                // Atualizar o campo de texto
                shareLink.value = shareableLink;
                
                // Gerar QR Code
                qrcodeContainer.innerHTML = '';
                new QRCode(qrcodeContainer, {
                    text: shareableLink,
                    width: 150,
                    height: 150,
                    colorDark: "#E63946",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Configurar links de compartilhamento
                if (shareWhatsapp) {
                    shareWhatsapp.href = `https://api.whatsapp.com/send?text=Fa√ßa seu pedido no Marcos: ${encodeURIComponent(shareableLink)}`;
                }
                
                if (shareTelegram) {
                    shareTelegram.href = `https://t.me/share/url?url=${encodeURIComponent(shareableLink)}&text=${encodeURIComponent('Fa√ßa seu pedido no Marcos')}`;
                }
                
                if (shareCustom) {
                    shareCustom.addEventListener('click', () => {
                        if (navigator.share) {
                            navigator.share({
                                title: 'Marcos',
                                text: 'Fa√ßa seu pedido no Marcos',
                                url: shareableLink
                            }).catch(console.error);
                        } else {
                            // Fallback para browsers que n√£o suportam a Web Share API
                            showNotification("Seu navegador n√£o suporta compartilhamento. Copie o link manualmente.");
                        }
                    });
                }
                
                // Mostrar modal
                shareModal.classList.remove('hidden');
            });
        }

        if (closeShareModal) {
            closeShareModal.addEventListener('click', () => {
                if (shareModal) shareModal.classList.add('hidden');
            });
        }

        if (copyLink && shareLink) {
            copyLink.addEventListener('click', () => {
                shareLink.select();
                document.execCommand('copy');
                showNotification("Link copiado para a √°rea de transfer√™ncia!");
            });
        }

        // ============ GERENCIAMENTO DE COMISS√ïES ============

        // Configurar comiss√µes
        if (applyCommission) {
            applyCommission.addEventListener('click', () => {
                if (!defaultCommission) return;
                commissionRates.default = parseFloat(defaultCommission.value) || 5;
                renderCommissionCategories();
                updateCommissionData();
                showNotification("Taxa de comiss√£o atualizada!");
                
                // Salvar as altera√ß√µes
                saveToStorage('commissionRates', commissionRates);
            });
        }

        function renderCommissionCategories() {
            if (!commissionCategories) return;
            
            commissionCategories.innerHTML = '';
            
            const categories = Object.keys(menuData);
            categories.forEach(category => {
                const categoryRow = document.createElement('div');
                categoryRow.classList.add('flex', 'items-center', 'justify-between', 'mb-3', 'p-3', 'bg-gray-50', 'dark:bg-gray-700', 'rounded');
                
                const rate = commissionRates.categories[category] || commissionRates.default;
                
                categoryRow.innerHTML = `
                    <label class="block font-medium">${category}</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" class="commission-rate p-2 w-20 border rounded text-base bg-white dark:bg-gray-600 dark:text-white dark:border-gray-600 form-input" 
                               data-category="${category}" value="${rate}" min="0" max="100">
                        <span>%</span>
                        <button class="apply-category-commission bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-sm transition duration-300 transform hover:scale-105"
                                data-category="${category}">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                `;
                
                commissionCategories.appendChild(categoryRow);
                
                // Adicionar event listener para o bot√£o
                const applyBtn = categoryRow.querySelector('.apply-category-commission');
                applyBtn.addEventListener('click', () => {
                    const category = applyBtn.getAttribute('data-category');
                    const input = categoryRow.querySelector('.commission-rate');
                    const rate = parseFloat(input.value) || commissionRates.default;
                    
                    commissionRates.categories[category] = rate;
                    updateCommissionData();
                    showNotification(`Comiss√£o para ${category} atualizada para ${rate}%`);
                    
                    // Salvar as altera√ß√µes
                    saveToStorage('commissionRates', commissionRates);
                });
            });
        }

        // Atualizar dados de comiss√£o quando o per√≠odo √© alterado
        if (commissionPeriod) {
            commissionPeriod.addEventListener('change', updateCommissionData);
        }

        function updateCommissionData() {
            if (!commissionPeriod || !commissionSales || !commissionTotal) return;
            
            const period = commissionPeriod.value;
            
            // Filtrar pedidos pelo per√≠odo selecionado
            const filteredOrders = filterOrdersByPeriod(orders, period);
            
            // Calcular total de vendas
            const totalSales = filteredOrders.reduce((sum, order) => sum + order.total, 0);
            
            // Calcular comiss√µes por categoria
            const commissionsByCategory = {};
            let totalCommission = 0;
            
            // Para cada pedido
            filteredOrders.forEach(order => {
                // Para cada item no pedido
                order.items.forEach(item => {
                    // Encontrar a categoria do item
                    let category = '';
                    for (const cat in menuData) {
                        if (menuData[cat].some(menuItem => menuItem.id === item.id)) {
                            category = cat;
                            break;
                        }
                    }
                    
                    if (category) {
                        // Calcular comiss√£o para este item
                        const rate = commissionRates.categories[category] || commissionRates.default;
                        const itemTotal = item.price * item.quantity;
                        const commission = (itemTotal * rate) / 100;
                        
                        // Adicionar √† categoria
                        if (!commissionsByCategory[category]) {
                            commissionsByCategory[category] = {
                                sales: 0,
                                commission: 0
                            };
                        }
                        
                        commissionsByCategory[category].sales += itemTotal;
                        commissionsByCategory[category].commission += commission;
                        totalCommission += commission;
                    }
                });
            });
            
            // Atualizar UI
            commissionSales.textContent = `R$ ${totalSales.toFixed(2)}`;
            commissionTotal.textContent = `R$ ${totalCommission.toFixed(2)}`;
            
            // Renderizar gr√°fico de barras
            renderCommissionChart(commissionsByCategory);
            
            // Atualizar hist√≥rico
            renderCommissionHistory(filteredOrders);
        }

        function renderCommissionChart(commissionsByCategory) {
            if (!commissionChart) return;
            
            commissionChart.innerHTML = '';
            
            const categories = Object.keys(commissionsByCategory);
            if (categories.length === 0) {
                commissionChart.innerHTML = '<p class="text-center text-gray-500 py-6">Sem dados para exibir.</p>';
                return;
            }
            
            // Encontrar o maior valor para escalar o gr√°fico
            const maxCommission = Math.max(...categories.map(cat => commissionsByCategory[cat].commission));
            
            // Largura de cada barra
            const barWidth = Math.min(50, Math.floor(commissionChart.clientWidth / (categories.length * 2)));
            
            // Espa√ßamento entre barras
            const spacing = barWidth;
            
            // Criar barras para cada categoria
            categories.forEach((category, index) => {
                const { commission } = commissionsByCategory[category];
                
                // Altura proporcional da barra (m√°ximo: 150px)
                const height = Math.max(20, Math.floor((commission / maxCommission) * 150));
                
                // Posi√ß√£o horizontal da barra
                const left = (index * (barWidth + spacing)) + spacing;
                
                // Criar elemento da barra
                const bar = document.createElement('div');
                bar.classList.add('bar');
                bar.style.height = `${height}px`;
                bar.style.width = `${barWidth}px`;
                bar.style.left = `${left}px`;
                bar.style.backgroundColor = 'var(--primary-color)';
                
                // Criar r√≥tulo da categoria
                const label = document.createElement('div');
                label.classList.add('bar-label');
                label.style.left = `${left}px`;
                label.textContent = category;
                
                // Criar valor da comiss√£o
                const value = document.createElement('div');
                value.classList.add('bar-value');
                value.style.left = `${left}px`;
                value.textContent = `R$ ${commission.toFixed(2)}`;
                
                // Adicionar elementos ao gr√°fico
                commissionChart.appendChild(bar);
                commissionChart.appendChild(label);
                commissionChart.appendChild(value);
            });
        }

        function renderCommissionHistory(filteredOrders) {
            if (!commissionHistory) return;
            
            commissionHistory.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                commissionHistory.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">Nenhuma comiss√£o registrada.</td></tr>';
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            const sortedOrders = [...filteredOrders].sort((a, b) => b.timestamp - a.timestamp);
            
            // Mostrar os √∫ltimos 10 pedidos
            const recentOrders = sortedOrders.slice(0, 10);
            
            recentOrders.forEach(order => {
                let totalCommission = 0;
                
                // Calcular comiss√£o para este pedido
                order.items.forEach(item => {
                    // Encontrar a categoria do item
                    let category = '';
                    for (const cat in menuData) {
                        if (menuData[cat].some(menuItem => menuItem.id === item.id)) {
                            category = cat;
                            break;
                        }
                    }
                    
                    if (category) {
                        const rate = commissionRates.categories[category] || commissionRates.default;
                        const itemTotal = item.price * item.quantity;
                        totalCommission += (itemTotal * rate) / 100;
                    }
                });
                
                // Criar linha na tabela
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'dark:border-gray-700', 'hover:bg-red-50', 'dark:hover:bg-red-900', 'transition-colors', 'duration-200');
                
                row.innerHTML = `
                    <td class="py-3">${new Date(order.timestamp).toLocaleDateString()}</td>
                    <td class="py-3">#${order.number}</td>
                    <td class="py-3">${order.customer.name}</td>
                    <td class="py-3 text-right">R$ ${order.total.toFixed(2)}</td>
                    <td class="py-3 text-right font-medium text-red-600 dark:text-red-400">R$ ${totalCommission.toFixed(2)}</td>
                `;
                
                commissionHistory.appendChild(row);
            });
        }

        function filterOrdersByPeriod(orders, period) {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay()); // Domingo como in√≠cio da semana
            startOfWeek.setHours(0, 0, 0, 0);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            
            let startDate;
            
            switch (period) {
                case 'day':
                    startDate = startOfDay;
                    break;
                case 'week':
                    startDate = startOfWeek;
                    break;
                case 'month':
                    startDate = startOfMonth;
                    break;
                case 'year':
                    startDate = startOfYear;
                    break;
                default:
                    startDate = startOfMonth; // Padr√£o: m√™s atual
            }
            
            return orders.filter(order => {
                const orderDate = new Date(order.timestamp);
                return orderDate >= startDate && order.status !== 'Cancelado';
            });
        }
        
        // Password strength check
        if (registerPassword) {
            registerPassword.addEventListener('input', function() {
                if (!passwordStrength) return;
                
                const password = this.value;
                let strength = 0;
                
                // Check length
                if (password.length >= 8) strength += 1;
                
                // Check for numbers
                if (/\d/.test(password)) strength += 1;
                
                // Check for special characters
                if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 1;
                
                // Check for uppercase letters
                if (/[A-Z]/.test(password)) strength += 1;
                
                // Update UI
                if (password.length === 0) {
                    passwordStrength.className = 'password-strength';
                    passwordStrength.style.width = '0';
                } else if (strength < 2) {
                    passwordStrength.className = 'password-strength password-weak';
                } else if (strength < 4) {
                    passwordStrength.className = 'password-strength password-medium';
                } else {
                    passwordStrength.className = 'password-strength password-strong';
                }
            });
        }

        // Customer Registration and Login
        if (customerLogin) {
            customerLogin.addEventListener('click', () => {
                if (!customerName || !customerPhone || !customerAddress || !clientSignin || !clientChat) return;
                
                const name = customerName.value.trim();
                const phone = customerPhone.value.trim();
                const address = customerAddress.value.trim();
                
                if (!name || !phone) {
                    showNotification("Por favor, preencha seu nome e WhatsApp!");
                    return;
                }
                
                // Check if customer already exists
                const existingCustomer = customers.find(c => c.phone === phone);
                if (existingCustomer) {
                    // Update existing customer
                    existingCustomer.name = name;
                    if (address) existingCustomer.address = address;
                    currentCustomer = existingCustomer;
                } else {
                    // Create new customer
                    const newCustomer = {
                        id: customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1,
                        name: name,
                        phone: phone,
                        address: address || '',
                        orders: 0,
                        lastOrder: null,
                        createdAt: new Date().toISOString()
                    };
                    customers.push(newCustomer);
                    currentCustomer = newCustomer;
                    
                    // Salvar o novo cliente para que seja acess√≠vel ao admin
                    saveToStorage('customers', customers);
                }
                
                // Set customer data for order
                customerData.name = name;
                customerData.phone = phone;
                customerData.address = address;
                
                // Show chat interface
                clientSignin.classList.add('hidden');
                clientChat.classList.remove('hidden');
                
                // Start chat flow
                startChatFlow();
            });
        }

        // Find customer by phone
        if (findByPhone) {
            findByPhone.addEventListener('click', () => {
                if (lookupModal) lookupModal.classList.remove('hidden');
            });
        }

        if (closeLookupModal) {
            closeLookupModal.addEventListener('click', () => {
                if (lookupModal) lookupModal.classList.add('hidden');
            });
        }

        if (cancelLookup) {
            cancelLookup.addEventListener('click', () => {
                if (lookupModal) lookupModal.classList.add('hidden');
            });
        }

        if (confirmLookup) {
            confirmLookup.addEventListener('click', () => {
                if (!lookupPhone || !customerName || !customerPhone || !customerAddress || !lookupModal) return;
                
                const phone = lookupPhone.value.trim();
                
                if (!phone) {
                    showNotification("Por favor, digite seu WhatsApp!");
                    return;
                }
                
                // Verificar pedidos recentes no localStorage antes de procurar localmente
                // Isso garante que os dados mais recentes sejam usados
                checkForNewOrdersAndUpdates();
                
                // Check if customer exists
                const existingCustomer = customers.find(c => c.phone === phone);
                if (existingCustomer) {
                    // Fill in the form with existing data
                    customerName.value = existingCustomer.name;
                    customerPhone.value = existingCustomer.phone;
                    customerAddress.value = existingCustomer.address || '';
                    
                    lookupModal.classList.add('hidden');
                    showNotification("Cliente encontrado! Dados preenchidos.");
                } else {
                    showNotification("Cliente n√£o encontrado. Por favor, cadastre-se.");
                    lookupPhone.value = phone;
                    lookupModal.classList.add('hidden');
                    customerPhone.value = phone;
                }
            });
        }

        // Chat bot conversation flow
        function startChatFlow() {
            if (!chatContainer) return;
            
            addBotMessage(`Ol√° ${currentCustomer.name}! Bem-vindo ao Marcos <i class="fas fa-hamburger ml-1 food-icon"></i>. Que tal fazer seu pedido agora mesmo? üòã`);
            
            setTimeout(() => {
                showOptions([
                    { text: "Ver Card√°pio", value: "menu" },
                    { text: "Repetir √öltimo Pedido", value: "repeat" }
                ]);
            }, 500);
        }

        // Admin login
        if (adminLoginButton) {
            adminLoginButton.addEventListener('click', () => {
                if (!adminEmail || !adminPassword) return;
                
                const email = adminEmail.value;
                const password = adminPassword.value;
                
                // Verificar pedidos recentes antes do login
                checkForNewOrdersAndUpdates();
                
                // Verify credentials
                const user = adminUsers.find(u => u.email === email && u.password === password);
                
                if (user) {
                    loggedIn = true;
                    
                    // Salvar o estado de login
                    saveToStorage('loggedInUser', email);
                    
                    // Update restaurant info
                    restaurantInfo = {
                        name: user.name,
                        address: user.address,
                        phone: user.phone
                    };
                    
                    if (infoName) infoName.textContent = restaurantInfo.name;
                    if (infoAddress) infoAddress.textContent = restaurantInfo.address;
                    if (infoPhone) infoPhone.textContent = restaurantInfo.phone;
                    
                    showNotification("Login realizado com sucesso!");
                    
                    // Play notification sound for existing orders
                    if (orders.length > 0) {
                        playNotificationSound();
                    }
                    
                    // Navigate to dashboard
                    navigateTo('admin-dashboard');
                } else {
                    showNotification("E-mail ou senha incorretos!");
                    
                    // Shake the form
                    const form = document.querySelector('#page-admin-login .bg-white');
                    if (form) {
                        form.classList.add('animate-shake');
                        setTimeout(() => {
                            form.classList.remove('animate-shake');
                        }, 500);
                    }
                }
            });
        }

        // Back to login button
        if (backToLogin) {
            backToLogin.addEventListener('click', () => {
                navigateTo('admin-login');
            });
        }

        // Admin logout
        if (adminLogout) {
            adminLogout.addEventListener('click', () => {
                loggedIn = false;
                // Remover o estado de login
                memoryStorage.loggedInUser = null;
                saveToStorage('loggedInUser', null);
                navigateTo('admin-login');
                
                // Clear admin login form
                if (adminEmail) adminEmail.value = '';
                if (adminPassword) adminPassword.value = '';
                
                showNotification("Voc√™ saiu da sua conta!");
            });
        }

        // Complete registration
        if (completeRegister) {
            completeRegister.addEventListener('click', () => {
                const registerName = document.getElementById('register-name');
                const registerAddress = document.getElementById('register-address');
                const registerPhone = document.getElementById('register-phone');
                const registerEmail = document.getElementById('register-email');
                const registerPassword = document.getElementById('register-password');
                const registerConfirm = document.getElementById('register-confirm');
                
                if (!registerName || !registerAddress || !registerPhone || !registerEmail || !registerPassword || !registerConfirm) return;
                
                const name = registerName.value.trim();
                const address = registerAddress.value.trim();
                const phone = registerPhone.value.trim();
                const email = registerEmail.value.trim();
                const password = registerPassword.value;
                const confirm = registerConfirm.value;
                
                if (!name || !address || !phone || !email || !password) {
                    showNotification("Por favor, preencha todos os campos!");
                    return;
                }
                
                if (password !== confirm) {
                    showNotification("As senhas n√£o coincidem!");
                    return;
                }
                
                // Check if email already exists
                if (adminUsers.some(user => user.email === email)) {
                    showNotification("Este e-mail j√° est√° cadastrado!");
                    return;
                }
                
                // Create new admin user
                const newAdmin = {
                    email: email,
                    password: password,
                    name: name,
                    address: address,
                    phone: phone
                };
                
                adminUsers.push(newAdmin);
                restaurantInfo = {
                    name: name,
                    address: address,
                    phone: phone
                };
                
                // Salvar dados atualizados
                saveToStorage('adminUsers', adminUsers);
                saveToStorage('restaurantInfo', restaurantInfo);
                
                // Update displayed info
                if (infoName) infoName.textContent = name;
                if (infoAddress) infoAddress.textContent = address;
                if (infoPhone) infoPhone.textContent = phone;
                
                showNotification("Cadastro realizado com sucesso!");
                
                // Switch back to login
                navigateTo('admin-login');
            });
        }

        // View all orders
        if (viewAllOrders) {
            viewAllOrders.addEventListener('click', () => {
                navigateTo('admin-orders');
            });
        }

        // Restaurant info editing
        if (editInfoButton) {
            editInfoButton.addEventListener('click', () => {
                if (!editName || !editAddress || !editPhone || !restaurantInfoDiv || !editInfoForm) return;
                
                editName.value = restaurantInfo.name;
                editAddress.value = restaurantInfo.address;
                editPhone.value = restaurantInfo.phone;
                
                restaurantInfoDiv.classList.add('hidden');
                editInfoForm.classList.remove('hidden');
            });
        }

        if (cancelEdit) {
            cancelEdit.addEventListener('click', () => {
                if (!restaurantInfoDiv || !editInfoForm) return;
                
                restaurantInfoDiv.classList.remove('hidden');
                editInfoForm.classList.add('hidden');
            });
        }

        if (saveInfo) {
            saveInfo.addEventListener('click', () => {
                if (!editName || !editAddress || !editPhone || !restaurantInfoDiv || !editInfoForm || !infoName || !infoAddress || !infoPhone) return;
                
                restaurantInfo.name = editName.value;
                restaurantInfo.address = editAddress.value;
                restaurantInfo.phone = editPhone.value;
                
                infoName.textContent = restaurantInfo.name;
                infoAddress.textContent = restaurantInfo.address;
                infoPhone.textContent = restaurantInfo.phone;
                
                // Update admin user
                const currentUser = adminUsers.find(u => u.email === (adminEmail ? adminEmail.value : ''));
                if (currentUser) {
                    currentUser.name = restaurantInfo.name;
                    currentUser.address = restaurantInfo.address;
                    currentUser.phone = restaurantInfo.phone;
                }
                
                // Salvar as informa√ß√µes atualizadas
                saveToStorage('restaurantInfo', restaurantInfo);
                saveToStorage('adminUsers', adminUsers);
                
                restaurantInfoDiv.classList.remove('hidden');
                editInfoForm.classList.add('hidden');
                
                showNotification("Informa√ß√µes atualizadas com sucesso!");
            });
        }

        // Cart toggle
        if (toggleCart) {
            toggleCart.addEventListener('click', () => {
                if (cartSidebar) cartSidebar.classList.toggle('translate-x-full');
            });
        }
        
        if (closeCart) {
            closeCart.addEventListener('click', () => {
                if (cartSidebar) cartSidebar.classList.add('translate-x-full');
            });
        }

        // Checkout button
        if (checkoutButton) {
            checkoutButton.addEventListener('click', () => {
                if (!cartSidebar) return;
                
                if (cart.length === 0) {
                    showNotification("Adicione itens ao carrinho primeiro!");
                    return;
                }
                
                cartSidebar.classList.add('translate-x-full');
                currentStep = 'delivery_method';
                addBotMessage("Como voc√™ deseja receber seu pedido?");
                    
                showOptions([
                    { text: "Retirada no Local", value: "pickup" },
                    { text: "Entrega em Casa", value: "delivery" }
                ]);
            });
        }

        // Close print modal
        if (closePrintModal) {
            closePrintModal.addEventListener('click', () => {
                if (printModal) printModal.classList.add('hidden');
            });
        }

        // Print receipt
        if (printReceipt) {
            printReceipt.addEventListener('click', () => {
                window.print();
            });
        }

        // Download receipt as PDF
        if (downloadReceipt) {
            downloadReceipt.addEventListener('click', () => {
                if (!printContent) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [80, 200]
                });
                
                doc.setFontSize(10);
                const content = printContent.innerText;
                const lines = content.split('\n');
                
                let y = 10;
                for (let line of lines) {
                    doc.text(line, 5, y);
                    y += 5;
                }
                
                doc.save(`pedido-${currentOrderNumber-1}.pdf`);
            });
        }

        // Filter orders by date
        if (applyFilter) {
            applyFilter.addEventListener('click', () => {
                if (!filterDate) return;
                
                const date = filterDate.value;
                if (!date) {
                    showNotification("Selecione uma data para filtrar!");
                    return;
                }
                
                updateOrdersList(date);
            });
        }

        if (clearFilter) {
            clearFilter.addEventListener('click', () => {
                if (filterDate) filterDate.value = '';
                updateOrdersList();
            });
        }

        // Export orders and customers
        if (exportOrdersCsv) {
            exportOrdersCsv.addEventListener('click', () => {
                exportDataToCsv(orders, 'orders');
            });
        }

        if (exportOrdersExcel) {
            exportOrdersExcel.addEventListener('click', () => {
                exportDataToExcel(orders, 'orders');
            });
        }

        if (exportCustomersCsv) {
            exportCustomersCsv.addEventListener('click', () => {
                exportDataToCsv(customers, 'customers');
            });
        }

        if (exportCustomersExcel) {
            exportCustomersExcel.addEventListener('click', () => {
                exportDataToExcel(customers, 'customers');
            });
        }
        
        if (exportCommissionsExcel) {
            exportCommissionsExcel.addEventListener('click', () => {
                exportCommissionsToExcel();
            });
        }

        // Send message on button click or Enter key
        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }
        
        if (messageInput) {
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // Chat functions
        function sendMessage() {
            if (!messageInput) return;
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            addCustomerMessage(message);
            messageInput.value = '';
            
            processUserInput(message);
        }

        function processUserInput(message) {
            switch(currentStep) {
                case 'welcome':
                    if (message.toLowerCase().includes('card√°pio') || message.toLowerCase().includes('menu')) {
                        showMenu();
                    } else if (message.toLowerCase().includes('repetir') || message.toLowerCase().includes('√∫ltimo')) {
                        checkLastOrder();
                    } else {
                        addBotMessage("Desculpe, n√£o entendi. Voc√™ gostaria de ver o card√°pio?");
                        showOptions([
                            { text: "Ver Card√°pio", value: "menu" },
                            { text: "Repetir √öltimo Pedido", value: "repeat" }
                        ]);
                    }
                    break;
                    
                case 'delivery_method':
                    if (message.toLowerCase().includes('retirada')) {
                        customerData.deliveryMethod = 'Retirada';
                        currentStep = 'payment';
                        addBotMessage("Qual a forma de pagamento?");
                        showOptions([
                            { text: "Dinheiro", value: "cash" },
                            { text: "Cart√£o", value: "card" },
                            { text: "Pix", value: "pix" }
                        ]);
                    } else if (message.toLowerCase().includes('entrega')) {
                        customerData.deliveryMethod = 'Entrega';
                        // We already have the address from registration
                        currentStep = 'payment';
                        addBotMessage("Qual a forma de pagamento?");
                        showOptions([
                            { text: "Dinheiro", value: "cash" },
                            { text: "Cart√£o", value: "card" },
                            { text: "Pix", value: "pix" }
                        ]);
                    } else {
                        addBotMessage("Por favor, escolha uma das op√ß√µes: Retirada no Local ou Entrega em Casa.");
                        showOptions([
                            { text: "Retirada no Local", value: "pickup" },
                            { text: "Entrega em Casa", value: "delivery" }
                        ]);
                    }
                    break;
                    
                case 'payment':
                    if (message.toLowerCase().includes('dinheiro')) {
                        customerData.paymentMethod = 'Dinheiro';
                        currentStep = 'order_notes';
                        addBotMessage("Gostaria de adicionar alguma observa√ß√£o ao seu pedido? (ex: sem cebola, ponto da carne, etc.)");
                    } else if (message.toLowerCase().includes('cart√£o') || message.toLowerCase().includes('cartao')) {
                        customerData.paymentMethod = 'Cart√£o';
                        currentStep = 'order_notes';
                        addBotMessage("Gostaria de adicionar alguma observa√ß√£o ao seu pedido? (ex: sem cebola, ponto da carne, etc.)");
                    } else if (message.toLowerCase().includes('pix')) {
                        customerData.paymentMethod = 'Pix';
                        currentStep = 'order_notes';
                        addBotMessage("Gostaria de adicionar alguma observa√ß√£o ao seu pedido? (ex: sem cebola, ponto da carne, etc.)");
                    } else {
                        addBotMessage("Por favor, escolha uma das formas de pagamento: Dinheiro, Cart√£o ou Pix.");
                        showOptions([
                            { text: "Dinheiro", value: "cash" },
                            { text: "Cart√£o", value: "card" },
                            { text: "Pix", value: "pix" }
                        ]);
                    }
                    break;
                    
                case 'order_notes':
                    // Save order notes
                    customerData.orderNotes = message;
                    if (message.toLowerCase() === "n√£o" || message.toLowerCase() === "nao") {
                        customerData.orderNotes = "";
                        addBotMessage("Ok, sem problemas.");
                    } else {
                        addBotMessage("Anotado! Adicionamos suas observa√ß√µes ao pedido.");
                    }
                    
                    // Show order summary
                    showOrderSummary();
                    break;
                    
                default:
                    // Check if it's an item from menu
                    const itemName = message.toLowerCase();
                    let found = false;
                    
                    for (const category in menuData) {
                        const items = menuData[category];
                        const item = items.find(i => i.name.toLowerCase() === itemName);
                        
                        if (item) {
                            // For drinks, add directly to cart
                            if (category === 'Bebidas') {
                                addToCart(item);
                                found = true;
                                addBotMessage(`${item.name} adicionado ao carrinho!`);
                                addBotMessage("Deseja adicionar mais algum item ao pedido?");
                                currentStep = 'adding_items';
                                showOptions([
                                    { text: "Ver Card√°pio", value: "menu" },
                                    { text: "Finalizar Pedido", value: "checkout" }
                                ]);
                            } else {
                                // For other items, show extras modal
                                found = true;
                                selectedItem = item;
                                showExtrasModal(item);
                            }
                            break;
                        }
                    }
                    
                    if (!found && currentStep === 'adding_items') {
                        addBotMessage("Desculpe, n√£o encontrei esse item no card√°pio. Voc√™ gostaria de escolher outro item?");
                        showOptions([
                            { text: "Ver Card√°pio", value: "menu" },
                            { text: "Finalizar Pedido", value: "checkout" }
                        ]);
                    }
            }
        }

        function handleOptionClick(value) {
            switch(value) {
                case 'menu':
                    showMenu();
                    break;
                    
                case 'repeat':
                    checkLastOrder();
                    break;
                    
                case 'checkout':
                    if (cart.length === 0) {
                        addBotMessage("Seu carrinho est√° vazio. Adicione algum item antes de finalizar o pedido.");
                        showMenu();
                    } else {
                        currentStep = 'delivery_method';
                        addBotMessage("Como voc√™ deseja receber seu pedido?");
                        showOptions([
                            { text: "Retirada no Local", value: "pickup" },
                            { text: "Entrega em Casa", value: "delivery" }
                        ]);
                    }
                    break;
                    
                case 'pickup':
                    customerData.deliveryMethod = 'Retirada';
                    currentStep = 'payment';
                    addBotMessage("Qual a forma de pagamento?");
                    showOptions([
                        { text: "Dinheiro", value: "cash" },
                        { text: "Cart√£o", value: "card" },
                        { text: "Pix", value: "pix" }
                    ]);
                    break;
                    
                case 'delivery':
                    customerData.deliveryMethod = 'Entrega';
                    // We already have the address from registration
                    currentStep = 'payment';
                    addBotMessage("Qual a forma de pagamento?");
                    showOptions([
                        { text: "Dinheiro", value: "cash" },
                        { text: "Cart√£o", value: "card" },
                        { text: "Pix", value: "pix" }
                    ]);
                    break;
                    
                case 'cash':
                case 'card':
                case 'pix':
                    customerData.paymentMethod = value === 'cash' ? 'Dinheiro' : (value === 'card' ? 'Cart√£o' : 'Pix');
                    currentStep = 'order_notes';
                    addBotMessage("Gostaria de adicionar alguma observa√ß√£o ao seu pedido? (ex: sem cebola, ponto da carne, etc.)");
                    break;
                    
                case 'confirm':
                    placeOrder();
                    break;
                    
                case 'cancel':
                    cancelOrder();
                    break;
                    
                default:
                    // Check if it's a category from menu
                    if (menuData[value]) {
                        showMenuCategory(value);
                    }
                    // Check if it's an item from menu (format: "add-X" where X is the item id)
                    else if (value.startsWith('add-')) {
                        const itemId = parseInt(value.split('-')[1]);
                        addItemById(itemId);
                    }
            }
        }

        function showMenu() {
            currentStep = 'browsing_menu';
            addBotMessage("Aqui est√° nosso card√°pio. Selecione uma categoria:");
            
            const categories = Object.keys(menuData);
            const options = categories.map(category => {
                return { text: category, value: category };
            });
            
            showOptions(options);
        }

        function showMenuCategory(category) {
            addBotMessage(`Aqui est√£o nossos itens de ${category}:`);
            
            const items = menuData[category];
            let messageContent = "";
            
            items.forEach(item => {
                // Adicionar badge de promo√ß√£o para alguns itens aleatoriamente
                const hasPromotion = Math.random() > 0.7;
                const promotionBadge = hasPromotion ? 
                    `<span class="promotion-badge ml-2">10% OFF</span>` : '';
                
                messageContent += `<div class="menu-item" onclick="handleOptionClick('add-${item.id}')">
                    <div>
                        <span class="font-medium">${item.name}${promotionBadge}</span>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${item.description}</p>
                    </div>
                    <span class="menu-item-price">R$ ${item.price.toFixed(2)}</span>
                </div>`;
            });
            
            addBotMessage(messageContent, true);
            
            showOptions([
                { text: "Ver outras categorias", value: "menu" },
                { text: "Finalizar Pedido", value: "checkout" }
            ]);
        }

        function addItemById(itemId) {
            for (const category in menuData) {
                const items = menuData[category];
                const item = items.find(i => i.id === itemId);
                
                if (item) {
                    // For drinks, add directly to cart
                    if (category === 'Bebidas') {
                        addToCart(item);
                        addBotMessage(`${item.name} adicionado ao carrinho!`);
                        addBotMessage("Deseja adicionar mais algum item ao pedido?");
                        currentStep = 'adding_items';
                        
                        showOptions([
                            { text: "Ver Card√°pio", value: "menu" },
                            { text: "Finalizar Pedido", value: "checkout" }
                        ]);
                    } else {
                        // For other items, show extras modal
                        selectedItem = item;
                        showExtrasModal(item);
                    }
                    break;
                }
            }
        }

        function checkLastOrder() {
            // Verificar pedidos recentes no localStorage antes de procurar localmente
            // Isso garante que os dados mais recentes sejam usados
            checkForNewOrdersAndUpdates();
            
            // Get last order for current customer
            const customerOrders = orders.filter(o => o.customer.phone === customerData.phone);
            
            if (customerOrders.length > 0) {
                const lastOrder = customerOrders[customerOrders.length - 1];
                
                addBotMessage("Encontrei seu √∫ltimo pedido. Deseja repetir?");
                
                let messageContent = "<div class='p-4 bg-red-50 dark:bg-red-900 rounded-lg shadow-md'>";
                lastOrder.items.forEach(item => {
                    messageContent += `<div class="flex justify-between py-1">
                        <span>${item.name} ${item.extras && item.extras.length > 0 ? '(' + item.extras.map(e => e.name).join(', ') + ')' : ''} x${item.quantity}</span>
                        <span class="font-medium">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                    </div>`;
                });
                messageContent += `<div class="font-bold mt-3 pt-2 border-t border-red-200 dark:border-red-700 flex justify-between">
                    <span>Total:</span>
                    <span>R$ ${lastOrder.total.toFixed(2)}</span>
                </div></div>`;
                
                addBotMessage(messageContent, true);
                
                showOptions([
                    { text: "Sim, repetir pedido", value: "repeat-confirm" },
                    { text: "N√£o, fazer novo pedido", value: "menu" }
                ]);
                
                // Set handler for repeat confirmation
                if (optionsContainer) {
                    const oldOptions = optionsContainer.querySelectorAll('button');
                    oldOptions.forEach(button => {
                        if (button.textContent.includes("Sim, repetir pedido")) {
                            button.onclick = () => {
                                // Clone the items from the last order
                                cart = JSON.parse(JSON.stringify(lastOrder.items));
                                customerData = JSON.parse(JSON.stringify(lastOrder.customer));
                                updateCartUI();
                                addBotMessage("Pedido anterior adicionado ao carrinho. Deseja finalizar ou modificar?");
                                
                                showOptions([
                                    { text: "Finalizar Pedido", value: "checkout" },
                                    { text: "Modificar Pedido", value: "menu" }
                                ]);
                            };
                        }
                    });
                }
            } else {
                addBotMessage("N√£o encontrei pedidos anteriores. Que tal fazer seu primeiro pedido?");
                showMenu();
            }
        }

        function showOrderSummary() {
            const total = calculateTotal();
            const deliveryFeeValue = calculateDeliveryFee(total);
            const orderTotal = total + deliveryFeeValue;
            
            addBotMessage("Aqui est√° o resumo do seu pedido:");
            
            let messageContent = "<div class='p-4 bg-red-50 dark:bg-red-900 rounded-lg shadow-md'>";
            cart.forEach(item => {
                messageContent += `<div class="flex justify-between mb-2">
                    <span>${item.name} ${item.extras && item.extras.length > 0 ? 
                        `<span class="text-sm text-gray-600 dark:text-gray-400">(${item.extras.map(e => e.name).join(', ')})</span>` : 
                        ''} x${item.quantity}</span>
                    <span class="font-medium">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                </div>`;
            });
            
            messageContent += `<div class="flex justify-between pt-2 border-t border-red-200 dark:border-red-700">
                <span>Subtotal:</span>
                <span>R$ ${total.toFixed(2)}</span>
            </div>`;
            
            // Adicionar taxa de entrega se aplic√°vel
            if (customerData.deliveryMethod === 'Entrega' && deliveryFeeValue > 0) {
                messageContent += `<div class="flex justify-between">
                    <span>Taxa de entrega:</span>
                    <span>R$ ${deliveryFeeValue.toFixed(2)}</span>
                </div>`;
            }
            
            messageContent += `<div class="flex justify-between font-bold">
                <span>Total:</span>
                <span>R$ ${orderTotal.toFixed(2)}</span>
            </div>`;
            
            messageContent += `<div class="mt-4 p-3 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                <p><strong>Nome:</strong> ${customerData.name}</p>
                ${customerData.deliveryMethod === 'Entrega' ? `<p><strong>Endere√ßo:</strong> ${customerData.address}</p>` : ''}
                <p><strong>WhatsApp:</strong> ${customerData.phone}</p>
                <p><strong>M√©todo:</strong> ${customerData.deliveryMethod}</p>
                <p><strong>Pagamento:</strong> ${customerData.paymentMethod}</p>`;
                
            // Add order notes if present
            if (customerData.orderNotes && customerData.orderNotes.trim() !== '') {
                messageContent += `<p><strong>Observa√ß√µes:</strong> ${customerData.orderNotes}</p>`;
            }
            
            messageContent += "</div></div>";
            
            addBotMessage(messageContent, true);
            
            currentStep = 'confirmation';
            showOptions([
                { text: "‚úÖ Confirmar Pedido", value: "confirm" },
                { text: "‚ùå Cancelar", value: "cancel" }
            ]);
        }

        function placeOrder() {
            // Calcular subtotal (itens)
            const subtotal = calculateTotal();
            
            // Calcular taxa de entrega
            const deliveryFeeValue = calculateDeliveryFee(subtotal);
            
            // Total final
            const orderTotal = subtotal + deliveryFeeValue;
            
            // Create order object
            const order = {
                number: currentOrderNumber++,
                items: [...cart],
                customer: {...customerData},
                subtotal: subtotal,
                deliveryFee: deliveryFeeValue,
                total: orderTotal,
                status: 'Novo',
                timestamp: new Date().getTime()
            };
            
            // Add to orders
            orders.push(order);
            
            // Salvar o pedido e incrementar o n√∫mero do pedido
            saveToStorage('orders', orders);
            saveToStorage('orderNumber', currentOrderNumber);
            
            // Update customer data
            if (currentCustomer) {
                currentCustomer.orders += 1;
                currentCustomer.lastOrder = new Date().toISOString();
                
                // Atualizar o cliente na lista
                const index = customers.findIndex(c => c.id === currentCustomer.id);
                if (index !== -1) {
                    customers[index] = currentCustomer;
                    saveToStorage('customers', customers);
                }
            }
            
            // Show confirmation
            addBotMessage("üéâ Pedido realizado com sucesso! üéâ");
            addBotMessage(`Seu pedido #${order.number} foi recebido e est√° sendo preparado.`);
            
            if (customerData.deliveryMethod === 'Entrega') {
                addBotMessage("Voc√™ receber√° uma mensagem quando o entregador estiver a caminho.");
            } else {
                addBotMessage("Voc√™ receber√° uma mensagem quando seu pedido estiver pronto para retirada.");
            }
            
            addBotMessage("Obrigado por escolher o Marcos! <i class='fas fa-hamburger food-icon'></i>");
            
            // Reset cart and state
            cart = [];
            updateCartUI();
            currentStep = 'welcome';
            
            // If admin is logged in, show notification
            if (loggedIn) {
                updateOrdersList();
                updateStats();
                updateRecentOrders();
                updateCustomersList();
                updateCommissionData();
                showNotification("Novo pedido recebido!");
                playNotificationSound();
            }
            
            // Notificar todos os dispositivos conectados sobre o novo pedido
            // Em ambiente real, isto seria feito via WebSockets ou similares
            notifyNewOrder(order);
            
            // Show options to start over
            setTimeout(() => {
                showOptions([
                    { text: "Fazer Novo Pedido", value: "menu" },
                    { text: "Sair", value: "exit" }
                ]);
            }, 1000);
        }

        // Fun√ß√£o simulada para notificar outros dispositivos sobre um novo pedido
        function notifyNewOrder(order) {
            memoryStorage.newOrderIndicator = {
                timestamp: new Date().getTime(),
                orderId: order.number
            };
            saveToStorage('newOrderIndicator', memoryStorage.newOrderIndicator);
        }

        function cancelOrder() {
            addBotMessage("Pedido cancelado. Deseja fazer um novo pedido?");
            
            // Reset cart and data
            cart = [];
            updateCartUI();
            customerData.deliveryMethod = '';
            customerData.paymentMethod = '';
            customerData.orderNotes = '';
            
            currentStep = 'welcome';
            showOptions([
                { text: "Sim, fazer novo pedido", value: "menu" },
                { text: "N√£o, sair", value: "exit" }
            ]);
        }

        // UI Helper Functions
        function addBotMessage(message, isHTML = false) {
            if (!chatContainer) return;
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', 'bot', 'animate-fade-in');
            
            if (isHTML) {
                messageElement.innerHTML = message;
            } else {
                messageElement.innerHTML = message;
            }
            
            // Adicionar hor√°rio da mensagem (estilo WhatsApp)
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            const now = new Date();
            timeDiv.textContent = now.getHours().toString().padStart(2, '0') + ':' + 
                                now.getMinutes().toString().padStart(2, '0');
            messageElement.appendChild(timeDiv);
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addCustomerMessage(message) {
            if (!chatContainer) return;
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', 'customer', 'animate-fade-in');
            messageElement.textContent = message;
            
            // Adicionar hor√°rio da mensagem (estilo WhatsApp)
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            const now = new Date();
            timeDiv.textContent = now.getHours().toString().padStart(2, '0') + ':' + 
                               now.getMinutes().toString().padStart(2, '0');
            messageElement.appendChild(timeDiv);
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Clear options when user sends a message
            clearOptions();
        }

        function showOptions(options) {
            if (!optionsContainer) return;
            
            clearOptions();
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = option.text;
                button.addEventListener('click', () => {
                    // Add as a customer message when they click an option
                    addCustomerMessage(option.text);
                    handleOptionClick(option.value);
                });
                
                optionsContainer.appendChild(button);
            });
        }

        function clearOptions() {
            if (!optionsContainer) return;
            
            while (optionsContainer.firstChild) {
                optionsContainer.removeChild(optionsContainer.firstChild);
            }
        }

        // Cart Functions
        function addToCart(item) {
            // Check if item already exists in cart
            const existingItem = cart.find(i => i.id === item.id && 
                                              (!i.extras || i.extras.length === 0));
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({...item, quantity: 1, extras: []});
            }
            
            updateCartUI();
        }

        function addToCartWithExtras(item, extras) {
            // Create a signature for this item with these specific extras
            const extrasSignature = extras.map(e => e.id).sort().join('-');
            
            // Calculate total price including extras
            let totalPrice = item.price;
            let extrasCost = 0;
            
            extras.forEach(extra => {
                extrasCost += extra.price;
            });
            
            totalPrice += extrasCost;
            
            // Check if this exact item with these extras already exists
            const existingItem = cart.find(i => 
                i.id === item.id && 
                i.extrasSignature === extrasSignature
            );
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...item, 
                    extras: extras,
                    extrasSignature: extrasSignature,
                    originalPrice: item.price,
                    price: totalPrice,
                    quantity: 1
                });
            }
            
            updateCartUI();
        }

        function updateCartUI() {
            if (!cartItems || !cartCount || !cartTotal) return;
            
            // Update cart items
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-center text-gray-500 py-6">Seu carrinho est√° vazio</p>';
                cartCount.textContent = '0';
                cartTotal.textContent = 'R$ 0,00';
                
                // Esconder se√ß√£o de taxa de entrega quando carrinho est√° vazio
                if (cartDeliveryFeeSection) {
                    cartDeliveryFeeSection.classList.add('hidden');
                }
                return;
            }
            
            // Update cart count
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems.toString();
            
            // Add items to cart
            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.classList.add('cart-item', 'py-3');
                
                // Exibir acr√©scimos se existirem
                const extrasText = item.extras && item.extras.length > 0 ? 
                    `<p class="text-sm text-gray-600 dark:text-gray-400">+ ${item.extras.map(e => e.name).join(', ')}</p>` : '';
                
                cartItem.innerHTML = `
                    <div>
                        <p class="font-medium">${item.name}</p>
                        ${extrasText}
                        <div class="flex items-center mt-2">
                            <button class="decrement-quantity bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300">-</button>
                            <span class="mx-3 font-medium">${item.quantity}</span>
                            <button class="increment-quantity bg-yellow-500 hover:bg-yellow-600 text-white rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300">+</button>
                        </div>
                    </div>
                    <div>
                        <p class="font-bold text-red-600 dark:text-red-400">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                        <button class="remove-item text-red-500 text-sm mt-1 hover:text-red-700 transition-all duration-300">
                            <i class="fas fa-trash mr-1"></i> Remover
                        </button>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
                
                // Add event listeners to buttons
                const decrementBtn = cartItem.querySelector('.decrement-quantity');
                const incrementBtn = cartItem.querySelector('.increment-quantity');
                const removeBtn = cartItem.querySelector('.remove-item');
                
                decrementBtn.addEventListener('click', () => {
                    if (item.quantity > 1) {
                        item.quantity -= 1;
                        updateCartUI();
                    }
                });
                
                incrementBtn.addEventListener('click', () => {
                    item.quantity += 1;
                    updateCartUI();
                });
                
                removeBtn.addEventListener('click', () => {
                    cart = cart.filter(i => i !== item);
                    updateCartUI();
                });
            });
            
            // Calcular taxa de entrega
            const subtotal = calculateTotal();
            const deliveryFeeValue = calculateDeliveryFee(subtotal);
            
            // Mostrar/esconder se√ß√£o de taxa de entrega
            if (cartDeliveryFeeSection && cartDeliveryFee) {
                if (deliveryFeeValue > 0) {
                    cartDeliveryFeeSection.classList.remove('hidden');
                    cartDeliveryFee.textContent = `R$ ${deliveryFeeValue.toFixed(2)}`;
                } else {
                    cartDeliveryFeeSection.classList.add('hidden');
                }
            }
            
            // Update total (incluindo taxa de entrega se aplic√°vel)
            const totalWithDelivery = subtotal + deliveryFeeValue;
            cartTotal.textContent = `R$ ${totalWithDelivery.toFixed(2)}`;
        }

        function calculateTotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        // Fun√ß√£o para calcular taxa de entrega
        function calculateDeliveryFee(subtotal) {
            // Retorna 0 se a taxa n√£o estiver habilitada ou se n√£o for entrega
            if (!deliveryFee.enabled || customerData.deliveryMethod !== 'Entrega') {
                return 0;
            }
            
            // Entrega gratuita para pedidos acima do valor m√≠nimo
            if (deliveryFee.freeDeliveryMinimum > 0 && subtotal >= deliveryFee.freeDeliveryMinimum) {
                return 0;
            }
            
            // Caso contr√°rio, retorna o valor da taxa
            return deliveryFee.amount;
        }

        // Admin Functions
        function updateOrdersList(filterByDate = null) {
            if (!ordersContainer || !noOrdersMessage) return;
            
            // Verificar se h√° pedidos novos antes de mostrar
            checkForNewOrdersAndUpdates();
            
            let filteredOrders = [...orders];
            
            // Apply date filter if provided
            if (filterByDate) {
                const filterDate = new Date(filterByDate);
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.timestamp);
                    return orderDate.toDateString() === filterDate.toDateString();
                });
            }
            
            if (filteredOrders.length === 0) {
                noOrdersMessage.classList.remove('hidden');
                ordersContainer.innerHTML = '';
                return;
            }
            
            noOrdersMessage.classList.add('hidden');
            ordersContainer.innerHTML = '';
            
            // Sort orders by timestamp (newest first)
            const sortedOrders = filteredOrders.sort((a, b) => b.timestamp - a.timestamp);
            
            sortedOrders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.classList.add('bg-white', 'dark:bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md', 'mb-4', 'transform', 'transition-all', 'duration-300', 'hover:-translate-y-1', 'hover:shadow-lg');
                
                // Order header
                const header = document.createElement('div');
                header.classList.add('flex', 'justify-between', 'items-center', 'mb-3');
                
                const orderNumber = document.createElement('div');
                orderNumber.innerHTML = `<span class="font-bold text-lg">#${order.number}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">${new Date(order.timestamp).toLocaleTimeString()}</span>`;
                
                const statusBadge = document.createElement('span');
                statusBadge.classList.add('px-3', 'py-1', 'rounded-full', 'text-xs', 'font-bold');
                
                if (order.status === 'Novo') {
                    statusBadge.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
                } else if (order.status === 'Entregue') {
                    statusBadge.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
                } else if (order.status === 'Cancelado') {
                    statusBadge.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                }
                
                statusBadge.textContent = order.status;
                
                header.appendChild(orderNumber);
                header.appendChild(statusBadge);
                orderElement.appendChild(header);
                
                // Customer info
                const customerInfo = document.createElement('div');
                customerInfo.classList.add('mb-3', 'text-sm', 'bg-gray-50', 'dark:bg-gray-800', 'p-3', 'rounded');
                customerInfo.innerHTML = `
                    <p><strong>Cliente:</strong> ${order.customer.name}</p>
                    <p><strong>WhatsApp:</strong> ${order.customer.phone}</p>
                    ${order.customer.deliveryMethod === 'Entrega' ? `<p><strong>Endere√ßo:</strong> ${order.customer.address}</p>` : ''}
                    <p><strong>M√©todo:</strong> ${order.customer.deliveryMethod} | <strong>Pagamento:</strong> ${order.customer.paymentMethod}</p>
                `;
                
                // Add order notes if present
                if (order.customer.orderNotes && order.customer.orderNotes.trim() !== '') {
                    customerInfo.innerHTML += `<p><strong>Observa√ß√µes:</strong> ${order.customer.orderNotes}</p>`;
                }
                
                orderElement.appendChild(customerInfo);
                
                // Order items
                const itemsList = document.createElement('div');
                itemsList.classList.add('mb-3', 'pl-3', 'border-l-2', 'border-red-500');
                
                order.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('flex', 'justify-between', 'text-sm', 'py-1');
                    
                    // Mostrar acr√©scimos se existirem
                    const extrasText = item.extras && item.extras.length > 0 ? 
                        ` (${item.extras.map(e => e.name).join(', ')})` : '';
                    
                    itemElement.innerHTML = `
                        <span>${item.name}${extrasText} x${item.quantity}</span>
                        <span class="font-medium">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                    `;
                    itemsList.appendChild(itemElement);
                });
                
                // Mostrar subtotal e taxa de entrega separadamente
                const subtotalElement = document.createElement('div');
                subtotalElement.classList.add('flex', 'justify-between', 'text-sm', 'pt-2', 'border-t', 'border-gray-200', 'dark:border-gray-700');
                subtotalElement.innerHTML = `
                    <span>Subtotal:</span>
                    <span class="font-medium">R$ ${(order.subtotal || order.total).toFixed(2)}</span>
                `;
                itemsList.appendChild(subtotalElement);
                
                // Mostrar taxa de entrega se aplic√°vel
                if (order.deliveryFee > 0) {
                    const feeElement = document.createElement('div');
                    feeElement.classList.add('flex', 'justify-between', 'text-sm');
                    feeElement.innerHTML = `
                        <span>Taxa de entrega:</span>
                        <span class="font-medium">R$ ${order.deliveryFee.toFixed(2)}</span>
                    `;
                    itemsList.appendChild(feeElement);
                }
                
                // Total (sempre exibido)
                const totalElement = document.createElement('div');
                totalElement.classList.add('font-bold', 'text-right', 'mt-2', 'text-red-600', 'dark:text-red-400', 'flex', 'justify-between');
                totalElement.innerHTML = `
                    <span>Total:</span>
                    <span>R$ ${order.total.toFixed(2)}</span>
                `;
                itemsList.appendChild(totalElement);
                
                orderElement.appendChild(itemsList);
                
                // Action buttons
                const actionButtons = document.createElement('div');
                actionButtons.classList.add('flex', 'flex-wrap', 'gap-2', 'mt-4');
                
                if (order.status !== 'Cancelado') {
                    const printButton = document.createElement('button');
                    printButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-2', 'px-4', 'rounded', 'text-sm', 'transition', 'duration-300', 'transform', 'hover:scale-105');
                    printButton.innerHTML = '<i class="fas fa-print mr-1"></i> Imprimir';
                    printButton.addEventListener('click', () => printOrderReceipt(order));
                    
                    const whatsappButton = document.createElement('button');
                    whatsappButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'py-2', 'px-4', 'rounded', 'text-sm', 'transition', 'duration-300', 'transform', 'hover:scale-105');
                    whatsappButton.innerHTML = '<i class="fab fa-whatsapp mr-1"></i> WhatsApp';
                    whatsappButton.addEventListener('click', () => {
                        // Open WhatsApp chat with customer
                        const message = encodeURIComponent(`Ol√° ${order.customer.name}, seu pedido #${order.number} do Marcos est√° sendo preparado!`);
                        window.open(`https://wa.me/${order.customer.phone.replace(/\D/g, '')}?text=${message}`, '_blank');
                    });
                    
                    actionButtons.appendChild(printButton);
                    actionButtons.appendChild(whatsappButton);
                }
                
                const statusButton = document.createElement('button');
                if (order.status === 'Novo') {
                    statusButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'py-2', 'px-4', 'rounded', 'text-sm', 'transition', 'duration-300', 'transform', 'hover:scale-105');
                    statusButton.innerHTML = '<i class="fas fa-check mr-1"></i> Marcar Entregue';
                    statusButton.addEventListener('click', () => {
                        order.status = 'Entregue';
                        
                        // Atualizar o pedido no storage
                        const orderIndex = orders.findIndex(o => o.number === order.number);
                        if (orderIndex !== -1) {
                            orders[orderIndex] = order;
                            saveToStorage('orders', orders);
                        }
                        
                        updateOrdersList(filterByDate);
                        updateStats();
                        updateRecentOrders();
                        updateCommissionData();
                    });
                } else if (order.status === 'Entregue') {
                    statusButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-2', 'px-4', 'rounded', 'text-sm', 'transition', 'duration-300', 'transform', 'hover:scale-105');
                    statusButton.innerHTML = '<i class="fas fa-times mr-1"></i> Cancelar';
                    statusButton.addEventListener('click', () => {
                        order.status = 'Cancelado';
                        
                        // Atualizar o pedido no storage
                        const orderIndex = orders.findIndex(o => o.number === order.number);
                        if (orderIndex !== -1) {
                            orders[orderIndex] = order;
                            saveToStorage('orders', orders);
                        }
                        
                        updateOrdersList(filterByDate);
                        updateStats();
                        updateRecentOrders();
                        updateCommissionData();
                    });
                } else {
                    statusButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'py-2', 'px-4', 'rounded', 'text-sm', 'transition', 'duration-300', 'transform', 'hover:scale-105');
                    statusButton.innerHTML = '<i class="fas fa-redo mr-1"></i> Restaurar';
                    statusButton.addEventListener('click', () => {
                        order.status = 'Novo';
                        
                        // Atualizar o pedido no storage
                        const orderIndex = orders.findIndex(o => o.number === order.number);
                        if (orderIndex !== -1) {
                            orders[orderIndex] = order;
                            saveToStorage('orders', orders);
                        }
                        
                        updateOrdersList(filterByDate);
                        updateStats();
                        updateRecentOrders();
                        updateCommissionData();
                    });
                }
                
                actionButtons.appendChild(statusButton);
                orderElement.appendChild(actionButtons);
                
                ordersContainer.appendChild(orderElement);
            });
        }

        function updateRecentOrders() {
            if (!recentOrders || !noRecentOrders) return;
            
            // Verificar se h√° pedidos novos antes de mostrar
            checkForNewOrdersAndUpdates();
            
            // Get 3 most recent orders
            const recentOrdersList = [...orders].sort((a, b) => b.timestamp - a.timestamp).slice(0, 3);
            
            if (recentOrdersList.length === 0) {
                noRecentOrders.classList.remove('hidden');
                recentOrders.innerHTML = '';
                return;
            }
            
            noRecentOrders.classList.add('hidden');
            recentOrders.innerHTML = '';
            
            recentOrdersList.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.classList.add('bg-white', 'dark:bg-gray-700', 'p-3', 'rounded-lg', 'shadow-sm', 'flex', 'justify-between', 'items-center', 'transform', 'transition-all', 'duration-300', 'hover:-translate-y-1', 'hover:shadow-md');
                
                let statusClass = 'text-yellow-500';
                if (order.status === 'Entregue') statusClass = 'text-green-500';
                if (order.status === 'Cancelado') statusClass = 'text-red-500';
                
                orderElement.innerHTML = `
                    <div>
                        <span class="font-medium">#${order.number}</span>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${order.customer.name} - ${new Date(order.timestamp).toLocaleTimeString()}</p>
                    </div>
                    <div class="flex items-center">
                        <span class="mr-3 font-bold text-red-600 dark:text-red-400">R$ ${order.total.toFixed(2)}</span>
                        <span class="px-2 py-1 rounded-full ${statusClass} text-xs">
                            <i class="fas fa-circle"></i>
                        </span>
                    </div>
                `;
                
                recentOrders.appendChild(orderElement);
            });
        }

        function updateCustomersList(search = '') {
            if (!customersTableBody) return;
            
            // Verificar novos clientes no localStorage
            checkForNewOrdersAndUpdates();
            
            if (customers.length === 0) {
                customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum cliente cadastrado.</td></tr>';
                return;
            }
            
            customersTableBody.innerHTML = '';
            
            // Filter customers if search term is provided
            let filteredCustomers = [...customers];
            if (search) {
                const searchLower = search.toLowerCase();
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchLower) || 
                    customer.phone.toLowerCase().includes(searchLower)
                );
            }
            
            // Sort by most recent order
            filteredCustomers.sort((a, b) => {
                if (!a.lastOrder) return 1;
                if (!b.lastOrder) return -1;
                return new Date(b.lastOrder) - new Date(a.lastOrder);
            });
            
            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'dark:border-gray-700', 'hover:bg-red-50', 'dark:hover:bg-red-900', 'transition-colors', 'duration-200');
                
                row.innerHTML = `
                    <td class="py-3">${customer.name}</td>
                    <td class="py-3">${customer.phone}</td>
                    <td class="py-3">${customer.address || '-'}</td>
                    <td class="py-3 text-center font-medium">${customer.orders}</td>
                    <td class="py-3 text-right">
                        <button class="text-green-500 hover:text-green-700 mr-3 transition-transform duration-300 transform hover:scale-125" data-action="whatsapp" data-phone="${customer.phone}">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700 transition-transform duration-300 transform hover:scale-125" data-action="view" data-id="${customer.id}">
                            <i class="fas fa-search"></i>
                        </button>
                    </td>
                `;
                
                // Add event listeners to buttons
                customersTableBody.appendChild(row);
                
                const whatsappBtn = row.querySelector('[data-action="whatsapp"]');
                const viewBtn = row.querySelector('[data-action="view"]');
                
                whatsappBtn.addEventListener('click', () => {
                    const message = encodeURIComponent(`Ol√° ${customer.name}, o Marcos agradece sua prefer√™ncia!`);
                    window.open(`https://wa.me/${customer.phone.replace(/\D/g, '')}?text=${message}`, '_blank');
                });
                
                viewBtn.addEventListener('click', () => {
                    viewCustomerOrders(customer);
                });
            });
        }

        function viewCustomerOrders(customer) {
            if (!ordersContainer) return;
            
            // Verificar pedidos recentes no localStorage
            checkForNewOrdersAndUpdates();
            
            // Get all orders for this customer
            const customerOrders = orders.filter(o => o.customer.phone === customer.phone);
            
            if (customerOrders.length === 0) {
                showNotification("Este cliente ainda n√£o fez nenhum pedido.");
                return;
            }
            
            // Navigate to the orders page
            navigateTo('admin-orders');
            
            // Apply a filter to show only this customer's orders
            ordersContainer.innerHTML = '';
            
            // Sort by most recent first
            const sortedOrders = customerOrders.sort((a, b) => b.timestamp - a.timestamp);
            
            sortedOrders.forEach(order => {
                // Display order (reusing the code from updateOrdersList)
                const orderElement = document.createElement('div');
                orderElement.classList.add('bg-white', 'dark:bg-gray-700', 'p-4', 'rounded-lg', 'shadow-md', 'mb-4', 'transform', 'transition-all', 'duration-300', 'hover:-translate-y-1', 'hover:shadow-lg');
                
                // Order header
                const header = document.createElement('div');
                header.classList.add('flex', 'justify-between', 'items-center', 'mb-3');
                
                const orderNumber = document.createElement('div');
                orderNumber.innerHTML = `<span class="font-bold text-lg">#${order.number}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">${new Date(order.timestamp).toLocaleString()}</span>`;
                
                const statusBadge = document.createElement('span');
                statusBadge.classList.add('px-3', 'py-1', 'rounded-full', 'text-xs', 'font-bold');
                
                if (order.status === 'Novo') {
                    statusBadge.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
                } else if (order.status === 'Entregue') {
                    statusBadge.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
                } else if (order.status === 'Cancelado') {
                    statusBadge.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                }
                
                statusBadge.textContent = order.status;
                
                header.appendChild(orderNumber);
                header.appendChild(statusBadge);
                orderElement.appendChild(header);
                
                // Order items
                const itemsList = document.createElement('div');
                itemsList.classList.add('mb-3', 'pl-3', 'border-l-2', 'border-red-500');
                
                order.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('flex', 'justify-between', 'text-sm', 'py-1');
                    
                    // Mostrar acr√©scimos se existirem
                    const extrasText = item.extras && item.extras.length > 0 ? 
                        ` (${item.extras.map(e => e.name).join(', ')})` : '';
                    
                    itemElement.innerHTML = `
                        <span>${item.name}${extrasText} x${item.quantity}</span>
                        <span class="font-medium">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                    `;
                    itemsList.appendChild(itemElement);
                });
                
                // Mostrar subtotal e taxa de entrega separadamente
                const subtotalElement = document.createElement('div');
                subtotalElement.classList.add('flex', 'justify-between', 'text-sm', 'pt-2', 'border-t', 'border-gray-200', 'dark:border-gray-700');
                subtotalElement.innerHTML = `
                    <span>Subtotal:</span>
                    <span class="font-medium">R$ ${(order.subtotal || (order.total - order.deliveryFee)).toFixed(2)}</span>
                `;
                itemsList.appendChild(subtotalElement);
                
                // Mostrar taxa de entrega se aplic√°vel
                if (order.deliveryFee > 0) {
                    const feeElement = document.createElement('div');
                    feeElement.classList.add('flex', 'justify-between', 'text-sm');
                    feeElement.innerHTML = `
                        <span>Taxa de entrega:</span>
                        <span class="font-medium">R$ ${order.deliveryFee.toFixed(2)}</span>
                    `;
                    itemsList.appendChild(feeElement);
                }
                
                // Total (sempre exibido)
                const totalElement = document.createElement('div');
                totalElement.classList.add('font-bold', 'text-right', 'mt-2', 'text-red-600', 'dark:text-red-400', 'flex', 'justify-between');
                totalElement.innerHTML = `
                    <span>Total:</span>
                    <span>R$ ${order.total.toFixed(2)}</span>
                `;
                itemsList.appendChild(totalElement);
                
                orderElement.appendChild(itemsList);
                
                // Action buttons
                const actionButtons = document.createElement('div');
                actionButtons.classList.add('flex', 'flex-wrap', 'gap-2', 'mt-4');
                
                if (order.status !== 'Cancelado') {
                    const printButton = document.createElement('button');
                    printButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-2', 'px-4', 'rounded', 'text-sm', 'transition', 'duration-300', 'transform', 'hover:scale-105');
                    printButton.innerHTML = '<i class="fas fa-print mr-1"></i> Imprimir';
                    printButton.addEventListener('click', () => printOrderReceipt(order));
                    
                    actionButtons.appendChild(printButton);
                }
                
                orderElement.appendChild(actionButtons);
                
                ordersContainer.appendChild(orderElement);
            });
            
            // Show a back button
            const backButton = document.createElement('button');
            backButton.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800', 'py-3', 'px-4', 'rounded', 'mt-4', 'w-full', 'transition', 'duration-300', 'transform', 'hover:scale-105');
            backButton.innerHTML = '<i class="fas fa-arrow-left mr-1"></i> Voltar para todos os pedidos';
            backButton.addEventListener('click', () => {
                updateOrdersList();
            });
            
            ordersContainer.appendChild(backButton);
            
            if (noOrdersMessage) noOrdersMessage.classList.add('hidden');
        }

        function updateStats() {
            if (!statsOrders || !statsTotal || !statsPix || !statsCard || !statsCash) return;
            
            // Verificar se h√° pedidos novos antes de atualizar estat√≠sticas
            checkForNewOrdersAndUpdates();
            
            // Count orders by status
            const totalOrders = orders.filter(order => order.status !== 'Cancelado').length;
            statsOrders.textContent = totalOrders;
            
            // Calculate total sales
            const totalSales = orders
                .filter(order => order.status !== 'Cancelado')
                .reduce((sum, order) => sum + order.total, 0);
            statsTotal.textContent = totalSales.toFixed(2);
            
            // Count payment methods
            const pixPayments = orders.filter(order => order.status !== 'Cancelado' && order.customer.paymentMethod === 'Pix').length;
            const cardPayments = orders.filter(order => order.status !== 'Cancelado' && order.customer.paymentMethod === 'Cart√£o').length;
            const cashPayments = orders.filter(order => order.status !== 'Cancelado' && order.customer.paymentMethod === 'Dinheiro').length;
            
            statsPix.textContent = `Pix: ${pixPayments}`;
            statsCard.textContent = `Cart√£o: ${cardPayments}`;
            statsCash.textContent = `Dinheiro: ${cashPayments}`;
        }

        function printOrderReceipt(order) {
            if (!printModal || !printContent) return;
            
            printContent.innerHTML = '';
            
            // Create receipt content
            let receiptHTML = `
                <div class="text-center font-bold mb-2">${restaurantInfo.name}</div>
                <div class="text-center text-sm mb-4">${restaurantInfo.address}<br>${restaurantInfo.phone}</div>
                <div>-------------------------</div>
                <div>Pedido N¬∫: ${order.number.toString().padStart(5, '0')}</div>
                <div>Cliente: ${order.customer.name}</div>
                <div>Data: ${new Date(order.timestamp).toLocaleString()}</div>
                <div>-------------------------</div>
                <div class="mb-2">Itens:</div>
            `;
            
            order.items.forEach(item => {
                // Incluir acr√©scimos se existirem
                const extrasText = item.extras && item.extras.length > 0 ? 
                    ` (${item.extras.map(e => e.name).join(', ')})` : '';
                
                receiptHTML += `<div>‚Ä¢ ${item.name}${extrasText} x${item.quantity} - R$ ${(item.price * item.quantity).toFixed(2)}</div>`;
            });
            
            // Subtotal (se houver taxa de entrega)
            if (order.deliveryFee > 0) {
                receiptHTML += `<div>-------------------------</div>`;
                receiptHTML += `<div>Subtotal: R$ ${(order.subtotal || (order.total - order.deliveryFee)).toFixed(2)}</div>`;
                receiptHTML += `<div>Taxa de entrega: R$ ${order.deliveryFee.toFixed(2)}</div>`;
            }
            
            receiptHTML += `
                <div>-------------------------</div>
                <div class="font-bold">Total: R$ ${order.total.toFixed(2)}</div>
                <div>Pagamento: ${order.customer.paymentMethod}</div>
                ${order.customer.deliveryMethod === 'Entrega' ? `<div>Entrega: ${order.customer.address}</div>` : '<div>Retirada no local</div>'}
            `;
            
            // Add order notes if present
            if (order.customer.orderNotes && order.customer.orderNotes.trim() !== '') {
                receiptHTML += `<div>Observa√ß√µes: ${order.customer.orderNotes}</div>`;
            }
            
            receiptHTML += `
                <div>-------------------------</div>
                <div class="text-center mt-2">Obrigado e volte sempre! <i class="fas fa-hamburger food-icon"></i></div>
            `;
            
            printContent.innerHTML = receiptHTML;
            printModal.classList.remove('hidden');
        }
        
        function showNotification(message) {
            if (!notification || !notificationText) return;
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function playNotificationSound() {
            try {
                // Create a sound effect for new orders
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                // Usando um som mais distinto e aumentando o volume
                oscillator.type = 'square'; // Formato de onda mais chamativo
                oscillator.frequency.value = 880;
                gainNode.gain.value = 0.5; // Volume aumentado de 0.1 para 0.5
                
                // Tocando o som com padr√£o de alerta (toca duas vezes)
                oscillator.start();
                
                setTimeout(() => {
                    oscillator.frequency.value = 1100; // Muda a frequ√™ncia ap√≥s 200ms
                }, 200);
                
                setTimeout(() => {
                    oscillator.stop();
                }, 600); // Dura√ß√£o mais longa para o alerta
            } catch (error) {
                console.log("Notification sound not supported in this environment");
            }
        }

        function renderMenuManagement() {
            if (!menuManagement) return;
            
            menuManagement.innerHTML = '';
            
            for (const category in menuData) {
                const categorySection = document.createElement('div');
                categorySection.classList.add('mb-5');
                
                const categoryHeader = document.createElement('div');
                categoryHeader.classList.add('flex', 'justify-between', 'items-center', 'mb-3');
                categoryHeader.innerHTML = `
                    <div class="flex items-center">
                        <h4 class="font-bold text-red-600 dark:text-red-400">${category}</h4>
                        <button class="edit-category text-red-500 hover:text-red-700 ml-2 transition-transform duration-300 transform hover:scale-110" data-category="${category}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-category text-red-500 hover:text-red-700 ml-2 transition-transform duration-300 transform hover:scale-110" data-category="${category}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <button class="add-to-category text-yellow-500 hover:text-yellow-700 text-sm transition-all duration-300 transform hover:scale-110" data-category="${category}">
                        <i class="fas fa-plus"></i> Adicionar Item
                    </button>
                `;
                
                categorySection.appendChild(categoryHeader);
                
                // Add event listener to add item button
                const addToCategoryBtn = categoryHeader.querySelector('.add-to-category');
                addToCategoryBtn.setAttribute('data-category', category);
                addToCategoryBtn.addEventListener('click', (e) => {
                    const targetCategory = e.currentTarget.getAttribute('data-category');
                    addNewMenuItem(targetCategory);
                });
                
                // Add event listeners for category edit/delete
                const editCategoryBtn = categoryHeader.querySelector('.edit-category');
                const deleteCategoryBtn = categoryHeader.querySelector('.delete-category');
                
                editCategoryBtn.addEventListener('click', () => {
                    editCategory(category);
                });
                
                deleteCategoryBtn.addEventListener('click', () => {
                    deleteCategory(category);
                });
                
                // Add items
                const itemsList = document.createElement('div');
                itemsList.classList.add('space-y-3', 'pl-4');
                
                menuData[category].forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'dark:bg-gray-700', 'p-3', 'rounded-lg', 'shadow-sm', 'transition-all', 'duration-300', 'hover:-translate-y-1', 'hover:shadow-md');
                    
                    itemElement.innerHTML = `
                        <div>
                            <div class="font-medium">${item.name}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${item.description}</div>
                        </div>
                        <div class="flex items-center">
                            <span class="mr-4 font-medium text-red-600 dark:text-red-400">R$ ${item.price.toFixed(2)}</span>
                            <button class="edit-item text-red-500 hover:text-red-700 mr-3 transition-transform duration-300 transform hover:scale-125">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-item text-red-500 hover:text-red-700 transition-transform duration-300 transform hover:scale-125">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    itemsList.appendChild(itemElement);
                    
                    // Add event listeners
                    const editBtn = itemElement.querySelector('.edit-item');
                    const deleteBtn = itemElement.querySelector('.delete-item');
                    
                    editBtn.addEventListener('click', () => {
                        editMenuItem(category, item);
                    });
                    
                    deleteBtn.addEventListener('click', () => {
                        deleteMenuItem(category, item);
                    });
                });
                
                categorySection.appendChild(itemsList);
                menuManagement.appendChild(categorySection);
            }
        }

        // Fun√ß√£o para editar uma categoria (NOVA)
        function editCategory(category) {
            const newName = prompt('Digite o novo nome da categoria:', category);
            if (newName && newName.trim() !== '' && newName !== category) {
                // Create a new category with the new name
                menuData[newName] = [...menuData[category]];
                // Delete the old category
                delete menuData[category];
                // Save the updated menu
                saveToStorage('menuData', menuData);
                // Re-render the menu
                renderMenuManagement();
                showNotification(`Categoria renomeada para "${newName}"!`);
            }
        }

        // Fun√ß√£o para excluir uma categoria (NOVA)
        function deleteCategory(category) {
            if (confirm(`Tem certeza que deseja excluir a categoria "${category}"? Todos os itens nesta categoria ser√£o exclu√≠dos.`)) {
                // Remove the category
                delete menuData[category];
                // Save the updated menu
                saveToStorage('menuData', menuData);
                // Re-render the menu
                renderMenuManagement();
                showNotification(`Categoria "${category}" exclu√≠da!`);
            }
        }

        function addNewMenuItem(category) {
            // Find the highest ID
            let maxId = 0;
            for (const cat in menuData) {
                menuData[cat].forEach(item => {
                    if (item.id > maxId) maxId = item.id;
                });
            }
            
            const newItem = {
                id: maxId + 1,
                name: 'Novo Item',
                price: 0.00,
                description: 'Descri√ß√£o do item'
            };
            
            menuData[category].push(newItem);
            // Salvar o card√°pio atualizado
            saveToStorage('menuData', menuData);
            renderMenuManagement();
            
            // Find and click the edit button for this new item
            setTimeout(() => {
                if (!menuManagement) return;
                
                const items = menuManagement.querySelectorAll('.edit-item');
                items[items.length - 1].click();
            }, 100);
        }

        function editMenuItem(category, item) {
            if (!menuManagement) return;
            
            // Create a form for editing
            const index = menuData[category].findIndex(i => i.id === item.id);
            if (index === -1) return;
            
            const items = menuManagement.querySelectorAll('.edit-item');
            if (!items || items.length <= index) return;
            
            const itemElement = items[index];
            if (!itemElement) return;
            
            const itemRow = itemElement.closest('.flex.justify-between.items-center');
            if (!itemRow) return;
            
            // Create edit form
            const editForm = document.createElement('div');
            editForm.classList.add('bg-red-50', 'dark:bg-red-900', 'p-4', 'rounded-lg', 'mt-3', 'shadow-md');
            
            editForm.innerHTML = `
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Nome</label>
                    <input type="text" class="edit-item-name w-full p-3 text-base border rounded bg-white dark:bg-gray-600 dark:text-white form-input" value="${item.name}">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Pre√ßo (R$)</label>
                    <input type="number" step="0.01" class="edit-item-price w-full p-3 text-base border rounded bg-white dark:bg-gray-600 dark:text-white form-input" value="${item.price}">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Descri√ß√£o</label>
                    <input type="text" class="edit-item-desc w-full p-3 text-base border rounded bg-white dark:bg-gray-600 dark:text-white form-input" value="${item.description}">
                </div>
                <div class="flex justify-end space-x-2">
                    <button class="cancel-edit bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition duration-300 btn">
                        Cancelar
                    </button>
                    <button class="save-item bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded transition duration-300 btn">
                        <i class="fas fa-save mr-1"></i> Salvar
                    </button>
                </div>
            `;
            
            // Insert after the item row
            itemRow.parentNode.insertBefore(editForm, itemRow.nextSibling);
            
            // Add event listeners
            const cancelBtn = editForm.querySelector('.cancel-edit');
            const saveBtn = editForm.querySelector('.save-item');
            
            cancelBtn.addEventListener('click', () => {
                editForm.remove();
            });
            
            saveBtn.addEventListener('click', () => {
                const nameInput = editForm.querySelector('.edit-item-name');
                const priceInput = editForm.querySelector('.edit-item-price');
                const descInput = editForm.querySelector('.edit-item-desc');
                
                menuData[category][index].name = nameInput.value;
                menuData[category][index].price = parseFloat(priceInput.value);
                menuData[category][index].description = descInput.value;
                
                // Salvar o card√°pio atualizado
                saveToStorage('menuData', menuData);
                renderMenuManagement();
                showNotification("Item atualizado com sucesso!");
            });
        }

        function deleteMenuItem(category, item) {
            if (confirm(`Tem certeza que deseja excluir "${item.name}"?`)) {
                menuData[category] = menuData[category].filter(i => i.id !== item.id);
                // Salvar o card√°pio atualizado
                saveToStorage('menuData', menuData);
                renderMenuManagement();
                showNotification("Item exclu√≠do com sucesso!");
            }
        }

        // Add event listener to the Add Menu Item button
        if (addMenuItem) {
            addMenuItem.addEventListener('click', () => {
                const categories = Object.keys(menuData);
                if (categories.length > 0) {
                    addNewMenuItem(categories[0]);
                } else {
                    showNotification("Adicione uma categoria primeiro!");
                }
            });
        }

        // Export functions
        function exportDataToCsv(data, type) {
            if (data.length === 0) {
                showNotification(`N√£o h√° ${type === 'orders' ? 'pedidos' : 'clientes'} para exportar!`);
                return;
            }
            
            let csv = '';
            
            if (type === 'orders') {
                csv = 'N√∫mero,Cliente,Total,Pagamento,Entrega,Observa√ß√µes,Data\n';
                
                data.forEach(order => {
                    const date = new Date(order.timestamp).toLocaleString();
                    csv += `${order.number},"${order.customer.name}",${order.total.toFixed(2)},"${order.customer.paymentMethod}","${order.customer.deliveryMethod}","${order.customer.orderNotes || ''}","${date}"\n`;
                });
            } else {
                csv = 'ID,Nome,WhatsApp,Endere√ßo,Pedidos,√öltimo Pedido,Cadastro\n';
                
                data.forEach(customer => {
                    csv += `${customer.id},"${customer.name}","${customer.phone}","${customer.address || ''}",${customer.orders},"${customer.lastOrder ? new Date(customer.lastOrder).toLocaleString() : ''}","${new Date(customer.createdAt).toLocaleString()}"\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            // Open in a new tab
            window.open(url, '_blank');
        }

        function exportDataToExcel(data, type) {
            if (data.length === 0) {
                showNotification(`N√£o h√° ${type === 'orders' ? 'pedidos' : 'clientes'} para exportar!`);
                return;
            }
            
            // Process data for Excel
            const workbookData = [];
            
            if (type === 'orders') {
                // Add headers
                workbookData.push(['N√∫mero', 'Cliente', 'Total', 'Pagamento', 'Entrega', 'Observa√ß√µes', 'Data']);
                
                // Add rows
                data.forEach(order => {
                    workbookData.push([
                        order.number,
                        order.customer.name,
                        order.total.toFixed(2),
                        order.customer.paymentMethod,
                        order.customer.deliveryMethod,
                        order.customer.orderNotes || '',
                        new Date(order.timestamp).toLocaleString()
                    ]);
                });
            } else {
                // Add headers
                workbookData.push(['ID', 'Nome', 'WhatsApp', 'Endere√ßo', 'Pedidos', '√öltimo Pedido', 'Cadastro']);
                
                // Add rows
                data.forEach(customer => {
                    workbookData.push([
                        customer.id,
                        customer.name,
                        customer.phone,
                        customer.address || '',
                        customer.orders,
                        customer.lastOrder ? new Date(customer.lastOrder).toLocaleString() : '',
                        new Date(customer.createdAt).toLocaleString()
                    ]);
                });
            }
            
            // Create workbook
            const worksheet = XLSX.utils.aoa_to_sheet(workbookData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, type === 'orders' ? 'Pedidos' : 'Clientes');
            
            // Generate Excel file
            const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            
            // Open in a new tab
            window.open(url, '_blank');
        }

        function exportCommissionsToExcel() {
            if (!commissionPeriod) return;
            
            const period = commissionPeriod.value;
            const filteredOrders = filterOrdersByPeriod(orders, period);
            
            if (filteredOrders.length === 0) {
                showNotification("N√£o h√° comiss√µes para exportar!");
                return;
            }
            
            // Calcular comiss√µes por pedido
            const commissionsData = [];
            
            // Add headers
            commissionsData.push(['Data', 'Pedido', 'Cliente', 'Categoria', 'Item', 'Quantidade', 'Valor', 'Taxa', 'Comiss√£o']);
            
            // Para cada pedido
            filteredOrders.forEach(order => {
                // Para cada item no pedido
                order.items.forEach(item => {
                    // Encontrar a categoria do item
                    let category = '';
                    let menuItem = null;
                    
                    for (const cat in menuData) {
                        const found = menuData[cat].find(m => m.id === item.id);
                        if (found) {
                            category = cat;
                            menuItem = found;
                            break;
                        }
                    }
                    
                    if (category && menuItem) {
                        // Calcular comiss√£o para este item
                        const rate = commissionRates.categories[category] || commissionRates.default;
                        const itemTotal = item.price * item.quantity;
                        const commission = (itemTotal * rate) / 100;
                        
                        // Adicionar linha para este item
                        commissionsData.push([
                            new Date(order.timestamp).toLocaleDateString(),
                            `#${order.number}`,
                            order.customer.name,
                            category,
                            menuItem.name,
                            item.quantity,
                            itemTotal.toFixed(2),
                            `${rate}%`,
                            commission.toFixed(2)
                        ]);
                    }
                });
            });
            
            // Adicionar resumo
            commissionsData.push([]);
            commissionsData.push(['Resumo por Categoria']);
            commissionsData.push(['Categoria', 'Vendas', 'Comiss√£o']);
            
            // Calcular totais por categoria
            const summary = {};
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    let category = '';
                    for (const cat in menuData) {
                        if (menuData[cat].some(m => m.id === item.id)) {
                            category = cat;
                            break;
                        }
                    }
                    
                    if (category) {
                        if (!summary[category]) {
                            summary[category] = { sales: 0, commission: 0 };
                        }
                        
                        const rate = commissionRates.categories[category] || commissionRates.default;
                        const itemTotal = item.price * item.quantity;
                        const commission = (itemTotal * rate) / 100;
                        
                        summary[category].sales += itemTotal;
                        summary[category].commission += commission;
                    }
                });
            });
            
            // Adicionar linhas de resumo
            for (const category in summary) {
                commissionsData.push([
                    category,
                    summary[category].sales.toFixed(2),
                    summary[category].commission.toFixed(2)
                ]);
            }
            
            // Create workbook
            const worksheet = XLSX.utils.aoa_to_sheet(commissionsData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Comiss√µes');
            
            // Generate Excel file
            const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            
            // Open in a new tab
            window.open(url, '_blank');
        }

        // Check for new orders and updates 
        function checkForNewOrdersAndUpdates() {
            const now = Date.now();
            // Verificar apenas a cada 5 segundos para n√£o sobrecarregar
            if (now - lastOrdersCheck < 5000) return;
            
            lastOrdersCheck = now;
            
            // Verificar se o indicador de novos pedidos est√° definido
            const newOrderIndicator = memoryStorage.newOrderIndicator;
            if (newOrderIndicator && newOrderIndicator.timestamp > lastOrdersCheck - 30000) {
                // Se estiver logado, mostrar notifica√ß√£o
                if (loggedIn) {
                    showNotification(`Novo pedido #${newOrderIndicator.orderId} recebido!`);
                    playNotificationSound();
                    
                    // Atualizar a interface
                    if (currentPage === 'admin-dashboard') {
                        updateStats();
                        updateRecentOrders();
                    } else if (currentPage === 'admin-orders') {
                        updateOrdersList();
                    }
                }
            }
        }

        // Listen for customer search input
        if (customerSearch) {
            customerSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                updateCustomersList(searchTerm);
            });
        }

        // Setup auto-checking for new orders and updates
        setInterval(checkForNewOrdersAndUpdates, 10000); // Verificar a cada 10 segundos

        // Make handleOptionClick globally available for menu items
        window.handleOptionClick = handleOptionClick;

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log("Initializing application...");
                
                // Verificar login
                const loggedInUser = memoryStorage.loggedInUser;
                if (loggedInUser) {
                    const user = adminUsers.find(u => u.email === loggedInUser);
                    if (user) {
                        loggedIn = true;
                        
                        // Update restaurant info
                        restaurantInfo = {
                            name: user.name,
                            address: user.address,
                            phone: user.phone
                        };
                        
                        if (infoName) infoName.textContent = restaurantInfo.name;
                        if (infoAddress) infoAddress.textContent = restaurantInfo.address;
                        if (infoPhone) infoPhone.textContent = restaurantInfo.phone;
                    }
                }
                
                // Aplicar modo escuro se necess√°rio
                if (appSettings.darkMode) {
                    document.documentElement.classList.add('dark');
                }
                
                // Inicializar a taxa de entrega
                if (deliveryFeeEnabled && deliveryFee) {
                    deliveryFeeEnabled.checked = deliveryFee.enabled;
                    
                    if (deliveryFeeAmount) {
                        deliveryFeeAmount.value = deliveryFee.amount.toFixed(2);
                    }
                    
                    if (deliveryFeeMinOrder) {
                        deliveryFeeMinOrder.value = deliveryFee.freeDeliveryMinimum > 0 ? 
                            deliveryFee.freeDeliveryMinimum.toFixed(2) : '';
                    }
                    
                    // Mostra/esconde as op√ß√µes da taxa de entrega
                    if (deliveryFeeOptions) {
                        deliveryFeeOptions.style.display = deliveryFee.enabled ? 'block' : 'none';
                    }
                }
                
                // Make sure DOM elements exist before accessing them
                if (defaultCommission) {
                    defaultCommission.value = commissionRates.default;
                }
                
                // Setup all commission categories
                renderCommissionCategories();
                
                // Check for client mode from URL
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                
                // Se for modo cliente, esconder as abas de admin
                if (mode === 'client') {
                    if (btnAdmin) btnAdmin.style.display = 'none';
                    if (btnRegister) btnRegister.style.display = 'none';
                }
                
                // Initialize the router
                initRouter();
                
                // Inicializar o banner de promo√ß√£o de acordo com as configura√ß√µes salvas
                updatePromotionDisplay();
                
                // Atualizar o contador de acr√©scimos
                updateExtrasCount();
                
                // Setup close button for promotion banner
                if (closePromotion && promotionBanner) {
                    closePromotion.addEventListener('click', () => {
                        promotionBanner.classList.add('hidden');
                    });
                }
                
                console.log("Application initialized successfully");
            } catch (error) {
                console.error("Error initializing application:", error);
            }
        });
    </script>
</body>
</html>